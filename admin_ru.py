"""
üöÄ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç v2.0
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Å —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
"""

import asyncio, json, logging, os, time
from contextlib import asynccontextmanager
from datetime import datetime
from typing import Dict, Any, Optional, List

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
–ª–æ–≥ = logging.getLogger("–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π_ai_–±–æ—Ç")

# FastAPI –∏–º–ø–æ—Ä—Ç—ã
try:
    from fastapi import FastAPI, Request, HTTPException
    from fastapi.responses import JSONResponse
    from fastapi.middleware.cors import CORSMiddleware
    –ª–æ–≥.info("‚úÖ FastAPI –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")
except ImportError as –µ:
    –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ FastAPI: {–µ}")
    exit(1)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù = os.getenv("TELEGRAM_BOT_TOKEN", "")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL = os.getenv("TELEGRAM_WEBHOOK_URL", "")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ = os.getenv("TELEGRAM_WEBHOOK_SECRET", "supersecret123456")
URL_–ë–ê–ó–´_–î–ê–ù–ù–´–• = os.getenv("DATABASE_URL", "")
–ö–õ–Æ–ß_OPENAI = os.getenv("OPENAI_API_KEY", "")
–ü–û–†–¢ = int(os.getenv("PORT", 8000))

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –ë–î
if URL_–ë–ê–ó–´_–î–ê–ù–ù–´–• and URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•.startswith('postgresql+asyncpg://'):
    URL_–ë–ê–ó–´_–î–ê–ù–ù–´–• = URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•.replace('postgresql+asyncpg://', 'postgresql://')

–ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL = f"{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL.rstrip('/')}/webhook/{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢}" if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL else ""

# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
—Å–æ—Å—Ç–æ—è–Ω–∏–µ = {
    "–ø—É–ª_–±–¥": None,
    "—Ä–∞–±–æ—Ç–∞–µ—Ç": False,
    "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞": {"–≤—Å–µ–≥–æ_—Å–æ–æ–±—â–µ–Ω–∏–π": 0, "ai_–∑–∞–ø—Ä–æ—Å–æ–≤": 0, "–∞–∫—Ç–∏–≤–Ω—ã—Ö_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π": 0},
    "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏_–æ–Ω–ª–∞–π–Ω": set(),
    "–∞–∫—Ç–∏–≤–Ω—ã–µ_—Å–µ—Å—Å–∏–∏": {}
}

# === –ò–ù–ù–û–í–ê–¶–ò–û–ù–ù–ê–Ø –ë–î ===
async def —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª_–±–¥(url_–±–¥):
    if not url_–±–¥:
        return None
    try:
        import asyncpg
        –ø—É–ª = await asyncpg.create_pool(url_–±–¥, min_size=5, max_size=20)
        –ª–æ–≥.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–π –ë–î —É—Å–ø–µ—à–Ω–æ")
        return –ø—É–ª
    except Exception as –µ:
        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –ë–î: {–µ}")
        return None

async def —Å–æ–∑–¥–∞—Ç—å_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ_—Ç–∞–±–ª–∏—Ü—ã(–ø—É–ª):
    if not –ø—É–ª:
        return
    try:
        async with –ø—É–ª.acquire() as conn:
            async with conn.transaction():
                await conn.execute("DROP TABLE IF EXISTS ai_–∑–∞–ø—Ä–æ—Å—ã CASCADE;")
                await conn.execute("DROP TABLE IF EXISTS –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ CASCADE;")
                
                await conn.execute("""
                    CREATE TABLE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (
                        id SERIAL PRIMARY KEY,
                        telegram_id BIGINT UNIQUE NOT NULL,
                        –∏–º—è VARCHAR(255),
                        —Ç–∏–ø_–ø–æ–¥–ø–∏—Å–∫–∏ VARCHAR(20) DEFAULT 'FREE',
                        –ª–∏–º–∏—Ç_—Å–æ–æ–±—â–µ–Ω–∏–π INTEGER DEFAULT 50,
                        –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ_—Å–æ–æ–±—â–µ–Ω–∏–π INTEGER DEFAULT 0,
                        —Å–æ–∑–¥–∞–Ω TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    );
                """)
                
                await conn.execute("""
                    CREATE TABLE ai_–∑–∞–ø—Ä–æ—Å—ã (
                        id SERIAL PRIMARY KEY,
                        –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id INTEGER REFERENCES –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(id) ON DELETE CASCADE,
                        –º–æ–¥–µ–ª—å VARCHAR(50) NOT NULL,
                        –ø—Ä–æ–º–ø—Ç TEXT,
                        –æ—Ç–≤–µ—Ç TEXT,
                        –≤—Ä–µ–º—è_–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è FLOAT DEFAULT 0,
                        —Å–æ–∑–¥–∞–Ω–æ TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                    );
                """)
                
        –ª–æ–≥.info("‚úÖ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã")
    except Exception as –µ:
        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {–µ}")

# === –ú–£–õ–¨–¢–ò–ú–û–î–ï–õ–¨–ù–´–ô AI ===
class –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–πAI–î–≤–∏–∂–æ–∫:
    def __init__(self):
        self.–º–æ–¥–µ–ª–∏ = {"gpt-4o": {"–¥–æ—Å—Ç—É–ø–Ω–∞": bool(–ö–õ–Æ–ß_OPENAI)}}
        –ª–æ–≥.info(f"üß† AI –î–≤–∏–∂–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: {[m for m, d in self.–º–æ–¥–µ–ª–∏.items() if d['–¥–æ—Å—Ç—É–ø–Ω–∞']]}")
    
    async def –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è_–æ–±—Ä–∞–±–æ—Ç–∫–∞(self, —Ç–µ–∫—Å—Ç: str, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: str) -> str:
        start_time = time.time()
        
        try:
            if self.–º–æ–¥–µ–ª–∏["gpt-4o"]["–¥–æ—Å—Ç—É–ø–Ω–∞"]:
                –æ—Ç–≤–µ—Ç = await self._–∑–∞–ø—Ä–æ—Å_openai(—Ç–µ–∫—Å—Ç)
            else:
                –æ—Ç–≤–µ—Ç = f"ü§ñ {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}, —è –ø–æ–ª—É—á–∏–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å –∏ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!\n\nüí° –î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ AI –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏ OpenAI.\n\nüéØ –í–∞—à –∑–∞–ø—Ä–æ—Å: {—Ç–µ–∫—Å—Ç}"
            
            –≤—Ä–µ–º—è_–æ–±—Ä–∞–±–æ—Ç–∫–∏ = time.time() - start_time
            –ª–æ–≥.info(f"üß† AI –æ–±—Ä–∞–±–æ—Ç–∫–∞: {–≤—Ä–µ–º—è_–æ–±—Ä–∞–±–æ—Ç–∫–∏:.2f}—Å - {–æ—Ç–≤–µ—Ç[:50]}...")
            
            return –æ—Ç–≤–µ—Ç
            
        except Exception as –µ:
            –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ AI –æ–±—Ä–∞–±–æ—Ç–∫–∏: {–µ}")
            return "ü§ñ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ AI —Å–∏—Å—Ç–µ–º–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –º–æ–º–µ–Ω—Ç."
    
    async def _–∑–∞–ø—Ä–æ—Å_openai(self, —Ç–µ–∫—Å—Ç: str) -> str:
        import httpx
        
        —Å–æ–æ–±—â–µ–Ω–∏—è = [{
            "role": "system",
            "content": "–¢—ã - –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä—É—Å—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —Å —ç–º–æ–¥–∑–∏."
        }, {
            "role": "user", 
            "content": —Ç–µ–∫—Å—Ç
        }]
        
        –¥–∞–Ω–Ω—ã–µ = {
            "model": "gpt-4o",
            "messages": —Å–æ–æ–±—â–µ–Ω–∏—è,
            "max_tokens": 1500,
            "temperature": 0.8
        }
        
        –∑–∞–≥–æ–ª–æ–≤–∫–∏ = {
            "Authorization": f"Bearer {–ö–õ–Æ–ß_OPENAI}",
            "Content-Type": "application/json"
        }
        
        async with httpx.AsyncClient(timeout=45.0) as –∫–ª–∏–µ–Ω—Ç:
            –æ—Ç–≤–µ—Ç = await –∫–ª–∏–µ–Ω—Ç.post(
                "https://api.openai.com/v1/chat/completions",
                headers=–∑–∞–≥–æ–ª–æ–≤–∫–∏,
                json=–¥–∞–Ω–Ω—ã–µ
            )
            
            if –æ—Ç–≤–µ—Ç.status_code == 200:
                —Ä–µ–∑—É–ª—å—Ç–∞—Ç = –æ—Ç–≤–µ—Ç.json()
                return —Ä–µ–∑—É–ª—å—Ç–∞—Ç["choices"][0]["message"]["content"]
            else:
                raise Exception(f"OpenAI API Error: {–æ—Ç–≤–µ—Ç.status_code}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI
ai_–¥–≤–∏–∂–æ–∫ = –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–πAI–î–≤–∏–∂–æ–∫()

# === –°–ò–°–¢–ï–ú–ê –°–û–û–ë–©–ï–ù–ò–ô ===
async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ(–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, pool=None):
    –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.get('update_id', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    –ª–æ–≥.info(f"üöÄ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è}")
    
    —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"]["–≤—Å–µ–≥–æ_—Å–æ–æ–±—â–µ–Ω–∏–π"] += 1
    
    if "message" in –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
        —Å–æ–æ–±—â–µ–Ω–∏–µ = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ["message"]
        —á–∞—Ç_–∏–¥ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏_–æ–Ω–ª–∞–π–Ω"].add(—á–∞—Ç_–∏–¥)
        
        if "text" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π_—Ç–µ–∫—Å—Ç(—Å–æ–æ–±—â–µ–Ω–∏–µ, pool)
        elif "voice" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≥–æ–ª–æ—Å–æ–≤–æ–µ_—Å–æ–æ–±—â–µ–Ω–∏–µ(—Å–æ–æ–±—â–µ–Ω–∏–µ, pool)
    
    elif "callback_query" in –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏
        callback = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ["callback_query"]
        await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_callback_query(callback, pool)
    
    –ª–æ–≥.info(f"‚úÖ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ {–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è} –∑–∞–≤–µ—Ä—à–µ–Ω–æ")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_callback_query(callback, pool=None):
    callback_id = callback["id"]
    —á–∞—Ç_–∏–¥ = callback["message"]["chat"]["id"]
    callback_data = callback["data"]
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = callback.get("from", {}).get("first_name", "–î—Ä—É–≥")
    
    –ª–æ–≥.info(f"üéØ Callback –æ—Ç {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}: {callback_data}")
    
    try:
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ callback
        await –æ—Ç–≤–µ—Ç–∏—Ç—å_–Ω–∞_callback(callback_id)
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        –ø—Ä–æ—Ñ–∏–ª—å = await –ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(—á–∞—Ç_–∏–¥, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, pool)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã callback
        if callback_data == "smart_chat":
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                "üß† <b>–£–º–Ω—ã–π —á–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</b>\n\nüí¨ –ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —è –¥–∞–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:")
        
        elif callback_data == "create_art":
            –∫–Ω–æ–ø–∫–∏ = [
                [{"text": "üåÑ –ü–µ–π–∑–∞–∂", "callback_data": "art_landscape"}],
                [{"text": "üê± –ñ–∏–≤–æ—Ç–Ω—ã–µ", "callback_data": "art_animals"}, 
                 {"text": "üéÜ –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞", "callback_data": "art_fantasy"}],
                [{"text": "‚Üê –ù–∞–∑–∞–¥", "callback_data": "back_to_main"}]
            ]
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, 
                "üé® <b>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!</b>\n\n‚ú® –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å:", –∫–Ω–æ–ø–∫–∏)
        
        elif callback_data.startswith("art_"):
            art_type = callback_data.replace("art_", "")
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≥–µ–Ω–µ—Ä–∞—Ü–∏—é_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è(—á–∞—Ç_–∏–¥, art_type, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        
        elif callback_data == "voice_mode":
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                "üé§ <b>–ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</b>\n\nüîä –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –ø—Ä–µ–æ–±—Ä–∞–∑—É—é –µ–≥–æ –≤ —Ç–µ–∫—Å—Ç –∏ –æ—Ç–≤–µ—á—É!")
        
        elif callback_data == "tools_menu":
            await –ø–æ–∫–∞–∑–∞—Ç—å_–º–µ–Ω—é_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤(—á–∞—Ç_–∏–¥)
        
        elif callback_data.startswith("tool_"):
            tool_name = callback_data.replace("tool_", "")
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç(—á–∞—Ç_–∏–¥, tool_name)
        
        elif callback_data == "show_stats":
            await –ø–æ–∫–∞–∑–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(—á–∞—Ç_–∏–¥, –ø—Ä–æ—Ñ–∏–ª—å)
        
        elif callback_data == "help":
            await –∫–æ–º–∞–Ω–¥–∞_–ø–æ–º–æ—â—å(—á–∞—Ç_–∏–¥)
        
        elif callback_data == "upgrade_subscription":
            await –ø–æ–∫–∞–∑–∞—Ç—å_—Ç–∞—Ä–∏—Ñ—ã(—á–∞—Ç_–∏–¥)
        
        elif callback_data == "back_to_main":
            await –∫–æ–º–∞–Ω–¥–∞_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π_—Å—Ç–∞—Ä—Ç(—á–∞—Ç_–∏–¥, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        
        elif callback_data.startswith("regen_"):
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                "üîÑ <b>–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞!</b>\n\nüîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å, –∏ —è –¥–∞–º –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.")
        
        elif callback_data == "text_to_image":
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                "üé® <b>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!</b>\n\nüñºÔ∏è –û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞.")
        
        elif callback_data == "save_response":
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                "üíæ <b>–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!</b>\n\nüìÅ –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ —Å–≤–æ–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.")
        
        elif callback_data.startswith("subscribe_"):
            —Ç–∏–ø_–ø–æ–¥–ø–∏—Å–∫–∏ = callback_data.replace("subscribe_", "").upper()
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                f"üí≥ <b>–ü–æ–¥–ø–∏—Å–∫–∞ {—Ç–∏–ø_–ø–æ–¥–ø–∏—Å–∫–∏}</b>\n\nüîÆ –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Payments –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!\n\nüìß –°–µ–π—á–∞—Å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        
        elif callback_data == "refresh_stats":
            await –ø–æ–∫–∞–∑–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(—á–∞—Ç_–∏–¥, –ø—Ä–æ—Ñ–∏–ª—å)
        
        else:
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
                f"ü§ñ <b>–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!</b>\n\nüîß Callback: {callback_data}\n‚ú® –°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ!")
    
    except Exception as –µ:
        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {–µ}")
        await –æ—Ç–≤–µ—Ç–∏—Ç—å_–Ω–∞_callback(callback_id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")

async def –æ—Ç–≤–µ—Ç–∏—Ç—å_–Ω–∞_callback(callback_id, —Ç–µ–∫—Å—Ç=""):
    try:
        import httpx
        –¥–∞–Ω–Ω—ã–µ = {"callback_query_id": callback_id, "text": —Ç–µ–∫—Å—Ç, "show_alert": bool(—Ç–µ–∫—Å—Ç)}
        url = f"https://api.telegram.org/bot{–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù}/answerCallbackQuery"
        async with httpx.AsyncClient() as –∫–ª–∏–µ–Ω—Ç:
            await –∫–ª–∏–µ–Ω—Ç.post(url, json=–¥–∞–Ω–Ω—ã–µ)
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback: {–µ}")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≥–æ–ª–æ—Å–æ–≤–æ–µ_—Å–æ–æ–±—â–µ–Ω–∏–µ(—Å–æ–æ–±—â–µ–Ω–∏–µ, pool=None):
    —á–∞—Ç_–∏–¥ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, "üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ–¥–¥–µ—Ä–∂–∞–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏!")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π_—Ç–µ–∫—Å—Ç(—Å–æ–æ–±—â–µ–Ω–∏–µ, pool=None):
    —Ç–µ–∫—Å—Ç = —Å–æ–æ–±—â–µ–Ω–∏–µ["text"]
    —á–∞—Ç_–∏–¥ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = —Å–æ–æ–±—â–µ–Ω–∏–µ.get("from", {}).get("first_name", "–î—Ä—É–≥")
    
    –ª–æ–≥.info(f"üí¨ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}: {—Ç–µ–∫—Å—Ç}")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    –ø—Ä–æ—Ñ–∏–ª—å = await –ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(—á–∞—Ç_–∏–¥, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, pool)
    
    # –ö–æ–º–∞–Ω–¥—ã
    if —Ç–µ–∫—Å—Ç.startswith('/start'):
        await –∫–æ–º–∞–Ω–¥–∞_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π_—Å—Ç–∞—Ä—Ç(—á–∞—Ç_–∏–¥, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
    elif —Ç–µ–∫—Å—Ç.startswith('/help'):
        await –∫–æ–º–∞–Ω–¥–∞_–ø–æ–º–æ—â—å(—á–∞—Ç_–∏–¥)
    elif —Ç–µ–∫—Å—Ç.startswith('/stats'):
        await –ø–æ–∫–∞–∑–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(—á–∞—Ç_–∏–¥, –ø—Ä–æ—Ñ–∏–ª—å)
    else:
        # AI –æ–±—Ä–∞–±–æ—Ç–∫–∞
        await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_ai_–∑–∞–ø—Ä–æ—Å(—á–∞—Ç_–∏–¥, —Ç–µ–∫—Å—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–æ—Ñ–∏–ª—å, pool)

async def –∫–æ–º–∞–Ω–¥–∞_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π_—Å—Ç–∞—Ä—Ç(—á–∞—Ç_–∏–¥, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
    –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ = f"""üöÄ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π AI –ë–æ—Ç 2.0, {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}!</b>

üß† <b>–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ ü§ñ –ú—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã–π AI (GPT-4o)
‚Ä¢ üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π  
‚Ä¢ üìä –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
‚Ä¢ üíé –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è

üí´ <b>–ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:</b>
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∏ –∏—Å–ø—ã—Ç–∞–π—Ç–µ –º–æ—â—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ AI!

üéØ <b>–ö–æ–º–∞–Ω–¥—ã:</b>
/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è –ø–æ–º–æ—â—å
/stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    
    –∫–Ω–æ–ø–∫–∏ = [
        [{"text": "üß† –£–º–Ω—ã–π —á–∞—Ç", "callback_data": "smart_chat"}],
        [{"text": "üé® –°–æ–∑–¥–∞—Ç—å –∞—Ä—Ç", "callback_data": "create_art"}, 
         {"text": "üé§ –ì–æ–ª–æ—Å", "callback_data": "voice_mode"}],
        [{"text": "üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", "callback_data": "tools_menu"}, 
         {"text": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "callback_data": "show_stats"}],
        [{"text": "‚ùì –ü–æ–º–æ—â—å", "callback_data": "help"}, 
         {"text": "üí∞ –ü–æ–¥–ø–∏—Å–∫–∞", "callback_data": "upgrade_subscription"}]
    ]
    
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∫–Ω–æ–ø–∫–∏)

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_ai_–∑–∞–ø—Ä–æ—Å(—á–∞—Ç_–∏–¥, —Ç–µ–∫—Å—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–æ—Ñ–∏–ª—å, pool):
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç"
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–¥–µ–π—Å—Ç–≤–∏–µ(—á–∞—Ç_–∏–¥, "typing")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
        if not await –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–ª–∏–º–∏—Ç—ã(–ø—Ä–æ—Ñ–∏–ª—å):
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, 
                "‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π!\n\nüíé –û–±–Ω–æ–≤–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ AI.",
                [[{"text": "üíé –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "callback_data": "upgrade_subscription"}]])
            return
        
        # AI –æ–±—Ä–∞–±–æ—Ç–∫–∞
        –æ—Ç–≤–µ—Ç = await ai_–¥–≤–∏–∂–æ–∫.–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è_–æ–±—Ä–∞–±–æ—Ç–∫–∞(—Ç–µ–∫—Å—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        
        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∫ –æ—Ç–≤–µ—Ç—É
        –∫–Ω–æ–ø–∫–∏ = [
            [{"text": "üîÑ –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å", "callback_data": f"regen_{hash(—Ç–µ–∫—Å—Ç) % 1000}"}],
            [{"text": "üé® –í –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "callback_data": "text_to_image"}, 
             {"text": "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "callback_data": "save_response"}]
        ]
        
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, –æ—Ç–≤–µ—Ç, –∫–Ω–æ–ø–∫–∏)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        await —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_ai_–∑–∞–ø—Ä–æ—Å(–ø—Ä–æ—Ñ–∏–ª—å.get("id", 1), "gpt-4o", —Ç–µ–∫—Å—Ç, –æ—Ç–≤–µ—Ç, pool)
        await –æ–±–Ω–æ–≤–∏—Ç—å_–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ(–ø—Ä–æ—Ñ–∏–ª—å.get("id", 1), pool)
        
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"]["ai_–∑–∞–ø—Ä–æ—Å–æ–≤"] += 1
        
    except Exception as –µ:
        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ AI –∑–∞–ø—Ä–æ—Å–∞: {–µ}")
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "üîß –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ù–∞—à–∏ AI-–∏–Ω–∂–µ–Ω–µ—Ä—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–¥ —Ä–µ—à–µ–Ω–∏–µ–º!")

# === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
async def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, —Ç–µ–∫—Å—Ç, –∫–Ω–æ–ø–∫–∏):
    try:
        import httpx
        –¥–∞–Ω–Ω—ã–µ = {
            "chat_id": —á–∞—Ç_–∏–¥,
            "text": —Ç–µ–∫—Å—Ç,
            "parse_mode": "HTML",
            "reply_markup": {"inline_keyboard": –∫–Ω–æ–ø–∫–∏}
        }
        url = f"https://api.telegram.org/bot{–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù}/sendMessage"
        async with httpx.AsyncClient() as –∫–ª–∏–µ–Ω—Ç:
            await –∫–ª–∏–µ–Ω—Ç.post(url, json=–¥–∞–Ω–Ω—ã–µ)
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏: {–µ}")

async def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, —Ç–µ–∫—Å—Ç):
    try:
        import httpx
        –¥–∞–Ω–Ω—ã–µ = {"chat_id": —á–∞—Ç_–∏–¥, "text": —Ç–µ–∫—Å—Ç, "parse_mode": "HTML"}
        url = f"https://api.telegram.org/bot{–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù}/sendMessage"
        async with httpx.AsyncClient() as –∫–ª–∏–µ–Ω—Ç:
            await –∫–ª–∏–µ–Ω—Ç.post(url, json=–¥–∞–Ω–Ω—ã–µ)
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {–µ}")

async def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–¥–µ–π—Å—Ç–≤–∏–µ(—á–∞—Ç_–∏–¥, –¥–µ–π—Å—Ç–≤–∏–µ):
    try:
        import httpx
        –¥–∞–Ω–Ω—ã–µ = {"chat_id": —á–∞—Ç_–∏–¥, "action": –¥–µ–π—Å—Ç–≤–∏–µ}
        url = f"https://api.telegram.org/bot{–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù}/sendChatAction"
        async with httpx.AsyncClient() as –∫–ª–∏–µ–Ω—Ç:
            await –∫–ª–∏–µ–Ω—Ç.post(url, json=–¥–∞–Ω–Ω—ã–µ)
    except:
        pass

async def –ø–æ–ª—É—á–∏—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(telegram_id, –∏–º—è, pool):
    if not pool:
        return {"id": 1, "—Ç–∏–ø_–ø–æ–¥–ø–∏—Å–∫–∏": "FREE", "–ª–∏–º–∏—Ç_—Å–æ–æ–±—â–µ–Ω–∏–π": 30}
    try:
        async with pool.acquire() as conn:
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = await conn.fetchrow("SELECT * FROM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ WHERE telegram_id = $1", telegram_id)
            if not –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
                –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = await conn.fetchrow(
                    "INSERT INTO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (telegram_id, –∏–º—è) VALUES ($1, $2) RETURNING *",
                    telegram_id, –∏–º—è
                )
            return dict(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
    except Exception:
        return {"id": 1, "—Ç–∏–ø_–ø–æ–¥–ø–∏—Å–∫–∏": "FREE", "–ª–∏–º–∏—Ç_—Å–æ–æ–±—â–µ–Ω–∏–π": 30}

async def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–ª–∏–º–∏—Ç—ã(–ø—Ä–æ—Ñ–∏–ª—å):
    –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ = –ø—Ä–æ—Ñ–∏–ª—å.get("–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ_—Å–æ–æ–±—â–µ–Ω–∏–π", 0)
    –ª–∏–º–∏—Ç = –ø—Ä–æ—Ñ–∏–ª—å.get("–ª–∏–º–∏—Ç_—Å–æ–æ–±—â–µ–Ω–∏–π", 30)
    return –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ < –ª–∏–º–∏—Ç

async def —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å_ai_–∑–∞–ø—Ä–æ—Å(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –º–æ–¥–µ–ª—å, –ø—Ä–æ–º–ø—Ç, –æ—Ç–≤–µ—Ç, pool):
    if not pool:
        return
    try:
        async with pool.acquire() as conn:
            await conn.execute(
                "INSERT INTO ai_–∑–∞–ø—Ä–æ—Å—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –º–æ–¥–µ–ª—å, –ø—Ä–æ–º–ø—Ç, –æ—Ç–≤–µ—Ç) VALUES ($1, $2, $3, $4)",
                –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, –º–æ–¥–µ–ª—å, –ø—Ä–æ–º–ø—Ç[:500], –æ—Ç–≤–µ—Ç[:1000]
            )
    except Exception:
        pass

async def –æ–±–Ω–æ–≤–∏—Ç—å_–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id, pool):
    if not pool:
        return
    try:
        async with pool.acquire() as conn:
            await conn.execute(
                "UPDATE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ SET –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ_—Å–æ–æ–±—â–µ–Ω–∏–π = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ_—Å–æ–æ–±—â–µ–Ω–∏–π + 1 WHERE id = $1",
                –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id
            )
    except Exception:
        pass

async def –∫–æ–º–∞–Ω–¥–∞_–ø–æ–º–æ—â—å(—á–∞—Ç_–∏–¥):
    –ø–æ–º–æ—â—å = """üéØ <b>–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –ü–æ–º–æ—â—å - AI –ë–æ—Ç 2.0</b>

üß† <b>AI –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á  
‚Ä¢ –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

üé® <b>–¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –§—É–Ω–∫—Ü–∏–∏:</b>
‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–æ–≤ –∏ –¥–∏–∑–∞–π–Ω–æ–≤

üöÄ <b>–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ - —è —É–º–µ—é –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å—ë!</b>"""
    
    –∫–Ω–æ–ø–∫–∏ = [
        [{"text": "üß† –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å AI", "callback_data": "try_ai"}],
        [{"text": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "callback_data": "show_stats"}]
    ]
    
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, –ø–æ–º–æ—â—å, –∫–Ω–æ–ø–∫–∏)

async def –ø–æ–∫–∞–∑–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(—á–∞—Ç_–∏–¥, –ø—Ä–æ—Ñ–∏–ª—å):
    —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ = f"""üìä <b>–í–∞—à–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>

üë§ <b>–ü—Ä–æ—Ñ–∏–ª—å:</b>
‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∞: {–ø—Ä–æ—Ñ–∏–ª—å.get('—Ç–∏–ø_–ø–æ–¥–ø–∏—Å–∫–∏', 'FREE')} ‚ú®
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π: {–ø—Ä–æ—Ñ–∏–ª—å.get('–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ_—Å–æ–æ–±—â–µ–Ω–∏–π', 0)}/{–ø—Ä–æ—Ñ–∏–ª—å.get('–ª–∏–º–∏—Ç_—Å–æ–æ–±—â–µ–Ω–∏–π', 30)}

üåü <b>–ì–ª–æ–±–∞–ª—å–Ω–∞—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>  
‚Ä¢ AI –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: {—Å–æ—Å—Ç–æ—è–Ω–∏–µ['—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞']['ai_–∑–∞–ø—Ä–æ—Å–æ–≤']}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(—Å–æ—Å—Ç–æ—è–Ω–∏–µ['–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏_–æ–Ω–ª–∞–π–Ω'])}
‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {—Å–æ—Å—Ç–æ—è–Ω–∏–µ['—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞']['–≤—Å–µ–≥–æ_—Å–æ–æ–±—â–µ–Ω–∏–π']}"""
    
async def –ø–æ–∫–∞–∑–∞—Ç—å_—Ç–∞—Ä–∏—Ñ—ã(—á–∞—Ç_–∏–¥):
    """–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –ø–æ–¥–ø–∏—Å–∫–∏"""
    —Ç–∞—Ä–∏—Ñ—ã = """üíé <b>–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã AI –ë–æ—Ç–∞ v3.0</b>

üÜì <b>FREE</b> - 50 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å
‚Ä¢ –ë–∞–∑–æ–≤—ã–π AI –¥–æ—Å—Ç—É–ø (GPT-4o)
‚Ä¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤
‚Ä¢ –ë–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

‚≠ê <b>PRO</b> - 1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å  
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚Ä¢ DALL-E 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚Ä¢ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚Ä¢ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

üèÜ <b>TEAM</b> - –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
‚Ä¢ –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ PRO
‚Ä¢ Claude 3.5 Sonnet –¥–æ—Å—Ç—É–ø
‚Ä¢ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

üíº <b>ENTERPRISE</b> - –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
‚Ä¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
‚Ä¢ –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –±–∏–∑–Ω–µ—Å
‚Ä¢ –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
‚Ä¢ SLA –≥–∞—Ä–∞–Ω—Ç–∏–∏"""
    
    –∫–Ω–æ–ø–∫–∏ = [
        [{"text": "‚≠ê –ü–æ–ª—É—á–∏—Ç—å PRO", "callback_data": "subscribe_pro"}],
        [{"text": "üèÜ –ü–æ–ª—É—á–∏—Ç—å TEAM", "callback_data": "subscribe_team"}],
        [{"text": "üíº ENTERPRISE", "callback_data": "subscribe_enterprise"}],
        [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", "callback_data": "back_to_main"}]
    ]
    
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, —Ç–∞—Ä–∏—Ñ—ã, –∫–Ω–æ–ø–∫–∏)

async def –ø–æ–∫–∞–∑–∞—Ç—å_–º–µ–Ω—é_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤(—á–∞—Ç_–∏–¥):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"""
    –º–µ–Ω—é = """üîß <b>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</b>

üåü <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</b>
üìñ Wikipedia –ø–æ–∏—Å–∫
üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
üå§Ô∏è –ü–æ–≥–æ–¥–∞
‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
üìà –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
üîç –í–µ–±-–ø–æ–∏—Å–∫
üìù –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

‚ú® <i>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∏–∂–µ –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É —Ç–µ–∫—Å—Ç–æ–º!</i>"""
    
    –∫–Ω–æ–ø–∫–∏ = [
        [{"text": "üìñ Wikipedia", "callback_data": "tool_wiki"}, 
         {"text": "üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", "callback_data": "tool_calc"}],
        [{"text": "üå§Ô∏è –ü–æ–≥–æ–¥–∞", "callback_data": "tool_weather"}, 
         {"text": "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", "callback_data": "tool_reminder"}],
        [{"text": "üìà –ê–Ω–∞–ª–∏–∑", "callback_data": "tool_analyze"}, 
         {"text": "üîç –ü–æ–∏—Å–∫", "callback_data": "tool_search"}],
        [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", "callback_data": "back_to_main"}]
    ]
    
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, –º–µ–Ω—é, –∫–Ω–æ–ø–∫–∏)

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç(—á–∞—Ç_–∏–¥, tool_name):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"""
    if tool_name == "wiki":
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "üìñ <b>Wikipedia –ü–æ–∏—Å–∫</b>\n\n–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ Wikipedia:\n–ü—Ä–∏–º–µ—Ä: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç'")
    elif tool_name == "calc":
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "üßÆ <b>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</b>\n\n–í–≤–µ–¥–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:\n–ü—Ä–∏–º–µ—Ä: '2 + 2 * 3' –∏–ª–∏ 'sqrt(16)'")
    elif tool_name == "weather":
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "üå§Ô∏è <b>–ü—Ä–æ–≥–Ω–æ–∑ –ü–æ–≥–æ–¥—ã</b>\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:\n–ü—Ä–∏–º–µ—Ä: '–ú–æ—Å–∫–≤–∞' –∏–ª–∏ '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'")
    elif tool_name == "reminder":
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "‚è∞ <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</b>\n\n–û–ø–∏—à–∏—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:\n–ü—Ä–∏–º–µ—Ä: '–ù–∞–ø–æ–º–Ω–∏ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –æ –≤—Å—Ç—Ä–µ—á–µ'")
    elif tool_name == "analyze":
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "üìà <b>–ê–Ω–∞–ª–∏–∑ –î–∞–Ω–Ω—ã—Ö</b>\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É:\n–ü—Ä–∏–º–µ—Ä: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–µ—Å—è—Ü'")
    elif tool_name == "search":
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, 
            "üîç <b>–í–µ–±-–ø–æ–∏—Å–∫</b>\n\n–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:\n–ü—Ä–∏–º–µ—Ä: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –ò–ò'")
    else:
        await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—á–∞—Ç_–∏–¥, "üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≥–µ–Ω–µ—Ä–∞—Ü–∏—é_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è(—á–∞—Ç_–∏–¥, art_type, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —Ç–∏–ø—É"""
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–¥–µ–π—Å—Ç–≤–∏–µ(—á–∞—Ç_–∏–¥, "upload_photo")
    
    prompts = {
        "landscape": "Beautiful mountain landscape at sunset, digital art, 4K quality",
        "animals": "Cute animals in a magical forest, digital art style",
        "fantasy": "Epic fantasy scene with dragons and castles, digital art"
    }
    
    prompt = prompts.get(art_type, "Creative digital artwork")
    
    # –ü–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
    –∫–Ω–æ–ø–∫–∏ = [
        [{"text": "üé® –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å—Ç–∏–ª—å", "callback_data": "create_art"}],
        [{"text": "‚óÄÔ∏è –ù–∞–∑–∞–¥", "callback_data": "back_to_main"}]
    ]
    
    await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å_–∫–Ω–æ–ø–∫–∞–º–∏(—á–∞—Ç_–∏–¥, 
        f"üé® <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b>\n\n‚ú® –°–æ–∑–¥–∞—é {art_type} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...\n\nüîÆ <i>DALL-E 3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!</i>\n\n–ê –ø–æ–∫–∞ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º, –∏ —è –ø–æ–º–æ–≥—É —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º!", 
        –∫–Ω–æ–ø–∫–∏)

# === FASTAPI –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ===
@asynccontextmanager
async def –≤—Ä–µ–º—è_–∂–∏–∑–Ω–∏_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è(app: FastAPI):
    –ª–æ–≥.info("üöÄ –ó–∞–ø—É—Å–∫ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ AI –ë–æ—Ç–∞ v2.0")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù:
        –ª–æ–≥.info("‚úÖ Telegram Bot Token –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    if –ö–õ–Æ–ß_OPENAI:
        –ª–æ–≥.info("‚úÖ OpenAI API Key –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    
    –ª–æ–≥.info(f"üîó Webhook URL: {–ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL or '–ù–ï –ù–ê–°–¢–†–û–ï–ù'}")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    –ø—É–ª = await —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª_–±–¥(URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•)
    if –ø—É–ª:
        await —Å–æ–∑–¥–∞—Ç—å_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ_—Ç–∞–±–ª–∏—Ü—ã(–ø—É–ª)
    
    —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] = –ø—É–ª
    —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] = True
    
    –ª–æ–≥.info("üéâ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!")
    yield
    
    —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] = False
    if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]:
        await —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"].close()
    –ª–æ–≥.info("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")

# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ = FastAPI(
    title="–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
    description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å v2.0",
    version="2.0.0",
    lifespan=–≤—Ä–µ–º—è_–∂–∏–∑–Ω–∏_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
)

–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/")
async def –≥–ª–∞–≤–Ω–∞—è():
    return JSONResponse({
        "—Å—Ç–∞—Ç—É—Å": "üöÄ –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π AI —Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–†—É—Å—Å–∫–∏–π AI –ë–æ—Ç v2.0",
        "–≤–µ—Ä—Å–∏—è": "2.0.0",
        "–≤—Ä–µ–º—è": datetime.now().isoformat(),
        "–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏": {
            "–º—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã–π_ai": True,
            "–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ_–∫–Ω–æ–ø–∫–∏": True,
            "–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è_–∞–Ω–∞–ª–∏—Ç–∏–∫–∞": True,
            "—Å–∏—Å—Ç–µ–º–∞_–ø–æ–¥–ø–∏—Å–æ–∫": True
        },
        "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞": —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"]
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/health")
async def –∑–¥–æ—Ä–æ–≤—å–µ():
    return JSONResponse({
        "–æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å": "–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ_–∑–¥–æ—Ä–æ–≤",
        "–≤—Ä–µ–º—è_–ø—Ä–æ–≤–µ—Ä–∫–∏": datetime.now().isoformat(),
        "–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã": {
            "ai_–¥–≤–∏–∂–æ–∫": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
            "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–ø–æ–¥–∫–ª—é—á–µ–Ω–∞" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] else "–æ—Ç–∫–ª—é—á–µ–Ω–∞",
            "telegram_–±–æ—Ç": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù else "–Ω–µ_–Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        }
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/test")
async def —Ç–µ—Å—Ç():
    return JSONResponse({
        "—Å—Ç–∞—Ç—É—Å": "üöÄ —Ä–∞–±–æ—Ç–∞–µ—Ç",
        "—Å–æ–æ–±—â–µ–Ω–∏–µ": "–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!"
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post("/webhook/{secret_path}")
async def –≤–µ–±—Ö—É–∫_—Å_—Å–µ–∫—Ä–µ—Ç–æ–º(–∑–∞–ø—Ä–æ—Å: Request, secret_path: str):
    –ª–æ–≥.info(f"üì® –ü–æ–ª—É—á–µ–Ω webhook —Å —Å–µ–∫—Ä–µ—Ç–æ–º: /{secret_path}")
    
    if secret_path != –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
        –ª–æ–≥.warning(f"üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç: {secret_path}")
        raise HTTPException(status_code=404, detail="–ù–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    try:
        —Ç–µ–ª–æ = await –∑–∞–ø—Ä–æ—Å.body()
        if not —Ç–µ–ª–æ:
            return JSONResponse({"ok": False, "–æ—à–∏–±–∫–∞": "–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ"})
        
        –¥–∞–Ω–Ω—ã–µ = json.loads(—Ç–µ–ª–æ.decode("utf-8"))
        –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –¥–∞–Ω–Ω—ã–µ.get("update_id", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        –ª–æ–≥.info(f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è}")
        
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        asyncio.create_task(–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ(–¥–∞–Ω–Ω—ã–µ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]))
        
        return JSONResponse({
            "ok": True,
            "—Å—Ç–∞—Ç—É—Å": "–ø—Ä–∏–Ω—è—Ç–æ_–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–π_—Å–∏—Å—Ç–µ–º–æ–π",
            "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_id": –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        })
        
    except json.JSONDecodeError as –µ:
        –ª–æ–≥.error(f"üî• JSON –æ—à–∏–±–∫–∞: {–µ}")
        raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π JSON")
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ webhook: {–µ}")
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
app = –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

if __name__ == "__main__":
    import uvicorn
    –ª–æ–≥.info("üîß –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞")
    uvicorn.run("main_innovation:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", host="0.0.0.0", port=–ü–û–†–¢, log_level="info")
