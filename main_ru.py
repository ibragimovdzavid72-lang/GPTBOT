"""
–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç v4.0
==========================================
–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–µ–π
"""

import asyncio
import json
import time
from contextlib import asynccontextmanager
from typing import Any, Dict

import structlog
import uvicorn
from fastapi import BackgroundTasks, FastAPI, HTTPException, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse

from config_ru import –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
from database_ru import –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–∞–∑—ã–î–∞–Ω–Ω—ã—Ö
from telegram_ru import –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç
from openai_ru import –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç
from handlers_ru import –û–±—Ä–∞–±–æ—Ç—á–∏–∫–°–æ–æ–±—â–µ–Ω–∏–π
from payments_ru import –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π
from analytics_ru import –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫
from admin_ru import –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–ë–æ—Ç–∞

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
structlog.configure(
    processors=[structlog.dev.ConsoleRenderer(colors=True)],
    wrapper_class=structlog.make_filtering_bound_logger(20),
    logger_factory=structlog.stdlib.LoggerFactory(),
    cache_logger_on_first_use=True,
)

–ª–æ–≥ = structlog.get_logger("–≥–ª–∞–≤–Ω—ã–π")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ = None
—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç = None
–æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç = None
–æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π = None
–º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π = None
–∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫ = None
–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä = None


@asynccontextmanager
async def –∂–∏–∑–Ω–µ–Ω–Ω—ã–π_—Ü–∏–∫–ª_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è(–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: FastAPI):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    await –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_—Å–µ—Ä–≤–∏—Å—ã()
    yield
    await –æ—á–∏—Å—Ç–∏—Ç—å_—Å–µ—Ä–≤–∏—Å—ã()


–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ = FastAPI(
    title="üöÄ AI CHAT 2 - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π –ë–æ—Ç",
    description="–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π AI-–±–æ—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏",
    version="4.0.0",
    lifespan=–∂–∏–∑–Ω–µ–Ω–Ω—ã–π_—Ü–∏–∫–ª_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
)

–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


async def –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_—Å–µ—Ä–≤–∏—Å—ã():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –±–æ—Ç–∞."""
    global –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π, –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    
    try:
        –ª–æ–≥.info("üöÄ –ó–∞–ø—É—Å–∫ AI CHAT 2...")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
        –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ = –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–∞–∑—ã–î–∞–Ω–Ω—ã—Ö()
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å()
        –ª–æ–≥.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
        —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç = –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç = –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç()
        –ª–æ–≥.info("‚úÖ API –∫–ª–∏–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π = –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π(—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫ = –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫(–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥) if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ñ—É–Ω–∫—Ü–∏–∏.–≤–∫–ª—é—á–∏—Ç—å_–∞–Ω–∞–ª–∏—Ç–∏–∫—É else None
        –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä = –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–ë–æ—Ç–∞(—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫)
        
        # –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º–∏
        –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π = –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π–û–±—Ä–∞–±–æ—Ç—á–∏–∫(
            —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, 
            –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫
        )
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞
        if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞:
            await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å_–≤–µ–±—Ö—É–∫(
                –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞,
                –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞
            )
            –ª–æ–≥.info("‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", —Å—Å—ã–ª–∫–∞=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞)
        
        –ª–æ–≥.info("üéâ AI CHAT 2 —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
        
    except Exception as e:
        –ª–æ–≥.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏", –æ—à–∏–±–∫–∞=str(e))
        raise


async def –æ—á–∏—Å—Ç–∏—Ç—å_—Å–µ—Ä–≤–∏—Å—ã():
    """–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏."""
    if —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç:
        await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.–∑–∞–∫—Ä—ã—Ç—å()
    if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥:
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–∑–∞–∫—Ä—ã—Ç—å()
    –ª–æ–≥.info("üîÑ –°–µ—Ä–≤–∏—Å—ã –æ—á–∏—â–µ–Ω—ã")


class –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π–û–±—Ä–∞–±–æ—Ç—á–∏–∫:
    """–ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏."""
    
    def __init__(self, —Ç–µ–ª–µ–≥—Ä–∞–º, –æ–ø–µ–Ω–∞–∏, –±–¥, –ø–ª–∞—Ç–µ–∂–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞):
        self.—Ç–µ–ª–µ–≥—Ä–∞–º = —Ç–µ–ª–µ–≥—Ä–∞–º
        self.–æ–ø–µ–Ω–∞–∏ = –æ–ø–µ–Ω–∞–∏
        self.–±–¥ = –±–¥
        self.–ø–ª–∞—Ç–µ–∂–∏ = –ø–ª–∞—Ç–µ–∂–∏
        self.–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ = –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
        self.—Å–æ—Å—Ç–æ—è–Ω–∏—è = {}
        
        # AI –ü–µ—Ä—Å–æ–Ω—ã
        self.–∞–∏_–ø–µ—Ä—Å–æ–Ω—ã = {
            "—ç–π–Ω—à—Ç–µ–π–Ω": {
                "–∏–º—è": "üß† –ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω",
                "–ø—Ä–æ–º—Ç": "–¢—ã –≥–µ–Ω–∏–∞–ª—å–Ω—ã–π —Ñ–∏–∑–∏–∫ –ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω. –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏ –ø—Ä–æ—Å—Ç–æ.",
                "—ç–º–æ–¥–∑–∏": "üß†"
            },
            "–¥–∞–≤–∏–Ω—á–∏": {
                "–∏–º—è": "üé® –õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏",
                "–ø—Ä–æ–º—Ç": "–¢—ã –≤–µ–ª–∏–∫–∏–π —Ö—É–¥–æ–∂–Ω–∏–∫ –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å. –î—É–º–∞–π –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ.",
                "—ç–º–æ–¥–∑–∏": "üé®"
            },
            "–¥–∂–æ–±—Å": {
                "–∏–º—è": "üíº –°—Ç–∏–≤ –î–∂–æ–±—Å",
                "–ø—Ä–æ–º—Ç": "–¢—ã –≤–∏–∑–∏–æ–Ω–µ—Ä. –ü–æ–º–æ–≥–∞–π —Å –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º–∏ –∏ –±–∏–∑–Ω–µ—Å–æ–º.",
                "—ç–º–æ–¥–∑–∏": "üíº"
            }
        }
    
    async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(self, —Å–æ–æ–±—â–µ–Ω–∏–µ: Dict[str, Any]):
        """–ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π."""
        try:
            –∏–¥_—á–∞—Ç–∞ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
            –¥–∞–Ω–Ω—ã–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = —Å–æ–æ–±—â–µ–Ω–∏–µ.get("from", {})
            —Ç–µ–ª–µ–≥—Ä–∞–º_–∏–¥ = –¥–∞–Ω–Ω—ã–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è["id"]
            
            # –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = await self.–±–¥.–ø–æ–ª—É—á–∏—Ç—å_–∏–ª–∏_—Å–æ–∑–¥–∞—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(
                —Ç–µ–ª–µ–≥—Ä–∞–º_–∏–¥=—Ç–µ–ª–µ–≥—Ä–∞–º_–∏–¥,
                –∏–º—è_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è=–¥–∞–Ω–Ω—ã–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.get("username"),
                –∏–º—è=–¥–∞–Ω–Ω—ã–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.get("first_name"),
                —Ñ–∞–º–∏–ª–∏—è=–¥–∞–Ω–Ω—ã–µ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.get("last_name")
            )
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            if "text" in —Å–æ–æ–±—â–µ–Ω–∏–µ and —Å–æ–æ–±—â–µ–Ω–∏–µ["text"].startswith("/"):
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–º–∞–Ω–¥—É(—Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
            elif "text" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Ç–µ–∫—Å—Ç(—Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            elif "photo" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ(—Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–∞
            elif "voice" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≥–æ–ª–æ—Å(—Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            
        except Exception as e:
            –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è", –æ—à–∏–±–∫–∞=str(e))
    
    async def _–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–º–∞–Ω–¥—É(self, —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥."""
        –∫–æ–º–∞–Ω–¥–∞ = —Å–æ–æ–±—â–µ–Ω–∏–µ["text"].split()[0].lower()
        –∏–¥_—á–∞—Ç–∞ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
        
        if –∫–æ–º–∞–Ω–¥–∞ == "/start":
            await self._–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ(–∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        elif –∫–æ–º–∞–Ω–¥–∞ == "/help":
            await self._–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–ø–æ–º–æ—â—å(–∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        elif –∫–æ–º–∞–Ω–¥–∞ == "/stats" and –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.—ç—Ç–æ_–∞–¥–º–∏–Ω:
            await –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.–ø–æ–∫–∞–∑–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(–∏–¥_—á–∞—Ç–∞)
    
    async def _–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ(self, –∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
        –∏–º—è = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–∏–º—è or "–î—Ä—É–≥"
        
        —Ç–µ–∫—Å—Ç = f"""üöÄ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AI CHAT 2, {–∏–º—è}!**

üß† **–ù–û–í–´–ï –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ ü§ñ –ú—É–ª—å—Ç–∏–º–æ–¥–µ–ª—å–Ω—ã–π AI (GPT-4o)
‚Ä¢ üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π DALL-E 3
‚Ä¢ üëÅÔ∏è –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚Ä¢ üîä –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ üìä –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
‚Ä¢ üíé –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è

‚ú® **–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
‚Ä¢ üßô‚Äç‚ôÇÔ∏è AI –ü–µ—Ä—Å–æ–Ω—ã (–≠–π–Ω—à—Ç–µ–π–Ω, –¥–∞ –í–∏–Ω—á–∏, –î–∂–æ–±—Å)
‚Ä¢ üéÆ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
‚Ä¢ üõ†Ô∏è –£–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
‚Ä¢ ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

üí´ **–ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:**
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∏ –∏—Å–ø—ã—Ç–∞–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ AI!"""
        
        –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ = self._—Å–æ–∑–¥–∞—Ç—å_–≥–ª–∞–≤–Ω—É—é_–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        
        await self.—Ç–µ–ª–µ–≥—Ä–∞–º.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(
            –∏–¥_—á–∞—Ç–∞=–∏–¥_—á–∞—Ç–∞,
            —Ç–µ–∫—Å—Ç=—Ç–µ–∫—Å—Ç,
            —Ä–∞–∑–º–µ—Ç–∫–∞_–æ—Ç–≤–µ—Ç–∞=–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        )
    
    def _—Å–æ–∑–¥–∞—Ç—å_–≥–ª–∞–≤–Ω—É—é_–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É(self, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
        """–°–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏."""
        –∫–Ω–æ–ø–∫–∏ = [
            [
                {"text": "üí¨ –£–º–Ω—ã–π —á–∞—Ç", "callback_data": "—Ñ—É–Ω–∫—Ü–∏—è:—á–∞—Ç"},
                {"text": "üé® –°–æ–∑–¥–∞—Ç—å –∞—Ä—Ç", "callback_data": "—Ñ—É–Ω–∫—Ü–∏—è:–∞—Ä—Ç"}
            ],
            [
                {"text": "üßô‚Äç‚ôÇÔ∏è AI –ü–µ—Ä—Å–æ–Ω—ã", "callback_data": "–ø–µ—Ä—Å–æ–Ω—ã:–º–µ–Ω—é"},
                {"text": "üëÅÔ∏è –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ", "callback_data": "—Ñ—É–Ω–∫—Ü–∏—è:–∞–Ω–∞–ª–∏–∑"}
            ],
            [
                {"text": "üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", "callback_data": "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:–º–µ–Ω—é"},
                {"text": "üéÆ –ò–≥—Ä—ã", "callback_data": "–∏–≥—Ä—ã:–º–µ–Ω—é"}
            ],
            [
                {"text": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "callback_data": "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:–º–æ–π"},
                {"text": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "callback_data": "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏:–º–µ–Ω—é"}
            ]
        ]
        
        if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ñ—É–Ω–∫—Ü–∏–∏.–≤–∫–ª—é—á–∏—Ç—å_–ø–ª–∞—Ç–µ–∂–∏:
            –∫–Ω–æ–ø–∫–∏.append([
                {"text": "üíé –ü—Ä–µ–º–∏—É–º", "callback_data": "–ø—Ä–µ–º–∏—É–º:—Ç–∞—Ä–∏—Ñ—ã"}
            ])
        
        return {"inline_keyboard": –∫–Ω–æ–ø–∫–∏}
    
    async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–ª–±–µ–∫(self, –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å: Dict[str, Any]):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø."""
        try:
            –∏–¥_–∑–∞–ø—Ä–æ—Å–∞ = –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å["id"]
            –¥–∞–Ω–Ω—ã–µ = –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å["data"]
            —Å–æ–æ–±—â–µ–Ω–∏–µ = –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å["message"]
            –∏–¥_—á–∞—Ç–∞ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
            –∏–¥_—Å–æ–æ–±—â–µ–Ω–∏—è = —Å–æ–æ–±—â–µ–Ω–∏–µ["message_id"]
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_–¥–∞–Ω–Ω—ã–µ = –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å["from"]
            
            # –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = await self.–±–¥.–ø–æ–ª—É—á–∏—Ç—å_–∏–ª–∏_—Å–æ–∑–¥–∞—Ç—å_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(
                –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_–¥–∞–Ω–Ω—ã–µ["id"]
            )
            
            # –†–∞–∑–±–æ—Ä callback –¥–∞–Ω–Ω—ã—Ö
            —á–∞—Å—Ç–∏ = –¥–∞–Ω–Ω—ã–µ.split(":")
            –¥–µ–π—Å—Ç–≤–∏–µ = —á–∞—Å—Ç–∏[0]
            –ø–∞—Ä–∞–º–µ—Ç—Ä = —á–∞—Å—Ç–∏[1] if len(—á–∞—Å—Ç–∏) > 1 else None
            
            # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
            if –¥–µ–π—Å—Ç–≤–∏–µ == "—Ñ—É–Ω–∫—Ü–∏—è":
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Ñ—É–Ω–∫—Ü–∏—é(–ø–∞—Ä–∞–º–µ—Ç—Ä, –∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            elif –¥–µ–π—Å—Ç–≤–∏–µ == "–ø–µ—Ä—Å–æ–Ω—ã":
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø–µ—Ä—Å–æ–Ω—ã(–ø–∞—Ä–∞–º–µ—Ç—Ä, –∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            elif –¥–µ–π—Å—Ç–≤–∏–µ == "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã":
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã(–ø–∞—Ä–∞–º–µ—Ç—Ä, –∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            elif –¥–µ–π—Å—Ç–≤–∏–µ == "–∏–≥—Ä—ã":
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–≥—Ä—ã(–ø–∞—Ä–∞–º–µ—Ç—Ä, –∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            elif –¥–µ–π—Å—Ç–≤–∏–µ == "–ø—Ä–µ–º–∏—É–º":
                await self._–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø—Ä–µ–º–∏—É–º(–ø–∞—Ä–∞–º–µ—Ç—Ä, –∏–¥_—á–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            
            # –û—Ç–≤–µ—Ç –Ω–∞ callback
            await self.—Ç–µ–ª–µ–≥—Ä–∞–º.–æ—Ç–≤–µ—Ç–∏—Ç—å_–Ω–∞_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å(–∏–¥_–∑–∞–ø—Ä–æ—Å–∞, "‚úÖ")
            
        except Exception as e:
            –ª–æ–≥.error("–û—à–∏–±–∫–∞ callback", –æ—à–∏–±–∫–∞=str(e))
            await self.—Ç–µ–ª–µ–≥—Ä–∞–º.–æ—Ç–≤–µ—Ç–∏—Ç—å_–Ω–∞_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å(
                –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å["id"], "‚ùå –û—à–∏–±–∫–∞"
            )


# API –º–∞—Ä—à—Ä—É—Ç—ã
@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø—É—Ç—å_–≤–µ–±—Ö—É–∫–∞)
async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≤–µ–±—Ö—É–∫(–∑–∞–ø—Ä–æ—Å: Request, —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏: BackgroundTasks):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram."""
    try:
        –¥–∞–Ω–Ω—ã–µ = await –∑–∞–ø—Ä–æ—Å.json()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞
        —Å–µ–∫—Ä–µ—Ç_–∑–∞–≥–æ–ª–æ–≤–æ–∫ = –∑–∞–ø—Ä–æ—Å.headers.get("X-Telegram-Bot-Api-Secret-Token")
        if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞ and —Å–µ–∫—Ä–µ—Ç_–∑–∞–≥–æ–ª–æ–≤–æ–∫ != –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞:
            raise HTTPException(status_code=403, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
        if "message" in –¥–∞–Ω–Ω—ã–µ:
            —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏.add_task(
                –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ,
                –¥–∞–Ω–Ω—ã–µ["message"]
            )
        elif "callback_query" in –¥–∞–Ω–Ω—ã–µ:
            —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏.add_task(
                –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–ª–±–µ–∫,
                –¥–∞–Ω–Ω—ã–µ["callback_query"]
            )
        
        return {"status": "ok"}
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞", –æ—à–∏–±–∫–∞=str(e))
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞")


@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/–∑–¥–æ—Ä–æ–≤—å–µ")
async def –ø—Ä–æ–≤–µ—Ä–∫–∞_–∑–¥–æ—Ä–æ–≤—å—è():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞."""
    return {
        "—Å—Ç–∞—Ç—É—Å": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–≤–µ—Ä—Å–∏—è": "4.0.0",
        "–≤—Ä–µ–º—è": time.time(),
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "üöÄ AI CHAT 2 - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π –ë–æ—Ç"
    }


if __name__ == "__main__":
    uvicorn.run(
        "main_ru:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        host=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ö–æ—Å—Ç,
        port=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–ø–æ—Ä—Ç,
        reload=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–æ—Ç–ª–∞–¥–∫–∞,
        log_level="info"
    )
