"""
–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç - –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å
======================================
–ü—Ä–æ–¥–∞–∫—à–Ω-–≥–æ—Ç–æ–≤—ã–π Telegram –±–æ—Ç —Å –ø–æ–ª–Ω–æ–π —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π
–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å OpenAI GPT-4o –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
"""

import asyncio
import json
import logging
import os
import sys
from contextlib import asynccontextmanager
from datetime import datetime
from typing import Dict, Any, Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler()]
)

–ª–æ–≥ = logging.getLogger("—Ä—É—Å—Å–∫–∏–π_–±–æ—Ç")

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
try:
    from fastapi import FastAPI, Request, HTTPException
    from fastapi.responses import JSONResponse
    from fastapi.middleware.cors import CORSMiddleware
    –ª–æ–≥.info("‚úÖ FastAPI –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")
except ImportError as –µ:
    –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ FastAPI: {–µ}")
    –ª–æ–≥.error("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install fastapi uvicorn")
    sys.exit(1)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù = os.getenv("TELEGRAM_BOT_TOKEN", "")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL = os.getenv("TELEGRAM_WEBHOOK_URL", "")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨ = os.getenv("TELEGRAM_WEBHOOK_PATH", "/webhook")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ = os.getenv("TELEGRAM_WEBHOOK_SECRET", "supersecret123456")
URL_–ë–ê–ó–´_–î–ê–ù–ù–´–• = os.getenv("DATABASE_URL", "")
–ö–õ–Æ–ß_OPENAI = os.getenv("OPENAI_API_KEY", "")
–ü–û–†–¢ = int(os.getenv("PORT", 8000))

# –ü–æ–ª–Ω—ã–π URL –¥–ª—è webhook
–ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL = f"{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL.rstrip('/')}{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨}" if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL else ""

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏
–ø—É–ª_–±–¥ = None
—Ä–∞–±–æ—Ç–∞–µ—Ç_—Å–∏—Å—Ç–µ–º–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π = True

# –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥—É–ª–µ–π
async def —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª(url_–±–¥):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–ª–∞ –ë–î."""
    if url_–±–¥:
        –ª–æ–≥.info("üìä –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...")
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å asyncpg
            import asyncpg
            return await asyncpg.create_pool(url_–±–¥, min_size=2, max_size=10)
        except ImportError:
            –ª–æ–≥.warning("‚ö†Ô∏è asyncpg –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            return None
        except Exception as –µ:
            –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {–µ}")
            return None
    return None

async def —Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã(–ø—É–ª):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü."""
    if –ø—É–ª:
        –ª–æ–≥.info("üìã –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ë–î...")
    pass

async def –ø–æ–ª—É—á–∏—Ç—å_–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è(–ø—É–ª):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    return []

async def –æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ_–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º(–ø—É–ª, –∏–¥_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è."""
    pass

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ(–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, pool=None):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Telegram."""
    –ª–æ–≥.info(f"üì® –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Telegram: {–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.get('update_id', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")

async def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º(–∏–¥_—á–∞—Ç–∞, —Ç–µ–∫—Å—Ç):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π."""
    –ª–æ–≥.info(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç {–∏–¥_—á–∞—Ç–∞}: {—Ç–µ–∫—Å—Ç[:50]}...")

async def –∑–∞–∫—Ä—ã—Ç—å_http_–∫–ª–∏–µ–Ω—Ç():
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞."""
    pass

# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
try:
    from db import create_pool as –∏–º–ø–æ—Ä—Ç_—Å–æ–∑–¥–∞—Ç—å_–ø—É–ª
    from db import create_tables as –∏–º–ø–æ—Ä—Ç_—Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã
    from db import due_reminders as –∏–º–ø–æ—Ä—Ç_–ø–æ–ª—É—á–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    from db import mark_reminder_done as –∏–º–ø–æ—Ä—Ç_–æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª = –∏–º–ø–æ—Ä—Ç_—Å–æ–∑–¥–∞—Ç—å_–ø—É–ª
    —Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã = –∏–º–ø–æ—Ä—Ç_—Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã
    –ø–æ–ª—É—á–∏—Ç—å_–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è = –∏–º–ø–æ—Ä—Ç_–ø–æ–ª—É—á–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    –æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ_–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º = –∏–º–ø–æ—Ä—Ç_–æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å db –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError as –µ:
    –ª–æ–≥.warning(f"‚ö†Ô∏è –ú–æ–¥—É–ª—å db –Ω–µ –Ω–∞–π–¥–µ–Ω: {–µ}")

try:
    from handlers import handle_update as –∏–º–ø–æ—Ä—Ç_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ = –∏–º–ø–æ—Ä—Ç_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å handlers –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError as –µ:
    –ª–æ–≥.warning(f"‚ö†Ô∏è –ú–æ–¥—É–ª—å handlers –Ω–µ –Ω–∞–π–¥–µ–Ω: {–µ}")

try:
    from telegram_api import tg_send_message as –∏–º–ø–æ—Ä—Ç_–æ—Ç–ø—Ä–∞–≤–∫–∞
    from telegram_api import close_http_client as –∏–º–ø–æ—Ä—Ç_–∑–∞–∫—Ä—ã—Ç—å_–∫–ª–∏–µ–Ω—Ç
    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º = –∏–º–ø–æ—Ä—Ç_–æ—Ç–ø—Ä–∞–≤–∫–∞
    –∑–∞–∫—Ä—ã—Ç—å_http_–∫–ª–∏–µ–Ω—Ç = –∏–º–ø–æ—Ä—Ç_–∑–∞–∫—Ä—ã—Ç—å_–∫–ª–∏–µ–Ω—Ç
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å telegram_api –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError as –µ:
    –ª–æ–≥.warning(f"‚ö†Ô∏è –ú–æ–¥—É–ª—å telegram_api –Ω–µ –Ω–∞–π–¥–µ–Ω: {–µ}")

try:
    from settings import *
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å settings –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError as –µ:
    –ª–æ–≥.warning(f"‚ö†Ô∏è –ú–æ–¥—É–ª—å settings –Ω–µ –Ω–∞–π–¥–µ–Ω: {–µ}")

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
—Å–æ—Å—Ç–æ—è–Ω–∏–µ = {
    "–ø—É–ª_–±–¥": None,
    "–∑–∞–¥–∞—á–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π": None,
    "—Ä–∞–±–æ—Ç–∞–µ—Ç": False
}

async def —Ä–∞–±–æ—Ç–Ω–∏–∫_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π():
    """–§–æ–Ω–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    –ª–æ–≥.info("üîÑ –ó–∞–ø—É—Å–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
    
    while —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"]:
        try:
            if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]:
                –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è = await –ø–æ–ª—É—á–∏—Ç—å_–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è(—Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"])
                
                for –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ in –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
                    try:
                        —Ç–µ–∫—Å—Ç_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è = f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.get('task', '–ó–∞–¥–∞—á–∞')}"
                        –∏–¥_—á–∞—Ç–∞ = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.get('chat_id')
                        
                        if –∏–¥_—á–∞—Ç–∞:
                            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º(–∏–¥_—á–∞—Ç–∞, —Ç–µ–∫—Å—Ç_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è)
                            await –æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ_–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º(
                                —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"], 
                                –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.get('id')
                            )
                            –ª–æ–≥.info(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.get('id')}")
                    except Exception as –æ—à–∏–±–∫–∞:
                        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {–æ—à–∏–±–∫–∞}")
            
            await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            
        except Exception as –æ—à–∏–±–∫–∞:
            –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {–æ—à–∏–±–∫–∞}")
            await asyncio.sleep(60)

@asynccontextmanager
async def –≤—Ä–µ–º—è_–∂–∏–∑–Ω–∏_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è(–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: FastAPI):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    –ª–æ–≥.info("üöÄ –ó–∞–ø—É—Å–∫ –†—É—Å—Å–∫–æ–≥–æ AI Telegram –ë–æ—Ç–∞ v1.0")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    –ª–æ–≥.info("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...")
    
    if not –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù:
        –ª–æ–≥.error("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    else:
        –ª–æ–≥.info("‚úÖ Telegram Bot Token –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    
    if not URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•:
        –ª–æ–≥.warning("‚ö†Ô∏è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—Ä–∞–±–æ—Ç–∞ –±–µ–∑ –ë–î)")
    else:
        –ª–æ–≥.info("‚úÖ Database URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    
    if not –ö–õ–Æ–ß_OPENAI:
        –ª–æ–≥.warning("‚ö†Ô∏è OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    else:
        –ª–æ–≥.info("‚úÖ OpenAI API Key –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        –ª–æ–≥.info("üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        –ø—É–ª = await —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª(URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•)
        if –ø—É–ª:
            await —Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã(–ø—É–ª)
            –ª–æ–≥.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞")
        else:
            –ª–æ–≥.warning("‚ö†Ô∏è –†–∞–±–æ—Ç–∞ –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] = –ø—É–ª
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] = True
        
        # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
        –ª–æ–≥.info("üîÑ –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö —Å–ª—É–∂–±...")
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–∑–∞–¥–∞—á–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"] = asyncio.create_task(—Ä–∞–±–æ—Ç–Ω–∏–∫_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π())
        
        –ª–æ–≥.info("üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        –ª–æ–≥.info(f"üåê –í–µ–±-—Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç {–ü–û–†–¢}")
        
        if –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL:
            –ª–æ–≥.info(f"üîó Webhook URL: {–ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL}")
        else:
            –ª–æ–≥.warning("‚ö†Ô∏è Webhook URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        yield
        
    except Exception as –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è_–æ—à–∏–±–∫–∞:
        –ª–æ–≥.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è_–æ—à–∏–±–∫–∞}")
        raise
    finally:
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        –ª–æ–≥.info("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] = False
        
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
        if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–∑–∞–¥–∞—á–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"]:
            —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–∑–∞–¥–∞—á–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"].cancel()
            try:
                await —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–∑–∞–¥–∞—á–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"]
            except asyncio.CancelledError:
                pass
        
        # –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        try:
            await –∑–∞–∫—Ä—ã—Ç—å_http_–∫–ª–∏–µ–Ω—Ç()
        except Exception as –µ:
            –ª–æ–≥.error(f"–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞: {–µ}")
        
        if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]:
            try:
                await —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"].close()
                –ª–æ–≥.info("üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫–ª—é—á–µ–Ω–∞")
            except Exception as –µ:
                –ª–æ–≥.error(f"–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ë–î: {–µ}")
        
        –ª–æ–≥.info("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

# –°–æ–∑–¥–∞–Ω–∏–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Ä—É—Å—Å–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ = FastAPI(
    title="–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
    description="–ü—Ä–æ–¥–∞–∫—à–Ω-–≥–æ—Ç–æ–≤—ã–π Telegram –±–æ—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
    version="1.0.0",
    lifespan=–≤—Ä–µ–º—è_–∂–∏–∑–Ω–∏_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è,
    docs_url="/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è",
    redoc_url="/—Å–ø—Ä–∞–≤–∫–∞"
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/")
async def –≥–ª–∞–≤–Ω–∞—è_—Å—Ç—Ä–∞–Ω–∏—Ü–∞():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ Railway."""
    return JSONResponse({
        "—Å—Ç–∞—Ç—É—Å": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
        "–≤–µ—Ä—Å–∏—è": "1.0.0",
        "–≤—Ä–µ–º—è": datetime.now().isoformat(),
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "Telegram –±–æ—Ç —Å –ò–ò –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "—Å–µ—Ä–≤–∏—Å": "Railway",
        "–ø–æ—Ä—Ç": –ü–û–†–¢,
        "–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã": {
            "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–ø–æ–¥–∫–ª—é—á–µ–Ω–∞" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] else "–æ—Ç–∫–ª—é—á–µ–Ω–∞",
            "—Å–∏—Å—Ç–µ–º–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π": "—Ä–∞–±–æ—Ç–∞–µ—Ç" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] else "–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞",
            "telegram_—Ç–æ–∫–µ–Ω": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
            "openai_–∫–ª—é—á": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –ö–õ–Æ–ß_OPENAI else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        }
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/health")
async def –ø—Ä–æ–≤–µ—Ä–∫–∞_–∑–¥–æ—Ä–æ–≤—å—è():
    """–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
    –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã = {
        "–≤–µ–±_—Å–µ—Ä–≤–µ—Ä": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–ø–æ–¥–∫–ª—é—á–µ–Ω–∞" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] else "–æ—Ç–∫–ª—é—á–µ–Ω–∞",
        "telegram_–±–æ—Ç": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù else "–Ω–µ_–Ω–∞—Å—Ç—Ä–æ–µ–Ω",
        "openai_api": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –ö–õ–Æ–ß_OPENAI else "–Ω–µ_–Ω–∞—Å—Ç—Ä–æ–µ–Ω",
        "webhook": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL else "–Ω–µ_–Ω–∞—Å—Ç—Ä–æ–µ–Ω",
        "—Å–∏—Å—Ç–µ–º–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π": "—Ä–∞–±–æ—Ç–∞–µ—Ç" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] else "–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    }
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã = ["–≤–µ–±_—Å–µ—Ä–≤–µ—Ä", "telegram_–±–æ—Ç"]
    –≤—Å–µ_–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_—Ä–∞–±–æ—Ç–∞—é—Ç = all(
        –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã[–∫–æ–º–ø–æ–Ω–µ–Ω—Ç] in ["—Ä–∞–±–æ—Ç–∞–µ—Ç", "–Ω–∞—Å—Ç—Ä–æ–µ–Ω"] 
        for –∫–æ–º–ø–æ–Ω–µ–Ω—Ç in –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    )
    
    –æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å = "–∑–¥–æ—Ä–æ–≤" if –≤—Å–µ_–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ_—Ä–∞–±–æ—Ç–∞—é—Ç else "–ø—Ä–æ–±–ª–µ–º—ã"
    
    return JSONResponse({
        "–æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å": –æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å,
        "–≤—Ä–µ–º—è_–ø—Ä–æ–≤–µ—Ä–∫–∏": datetime.now().isoformat(),
        "–≤–µ—Ä—Å–∏—è": "1.0.0",
        "–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞": "Railway",
        "–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã": –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã,
        "–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è": {
            "–ø–æ—Ä—Ç": –ü–û–†–¢,
            "webhook_–ø—É—Ç—å": –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨,
            "–µ—Å—Ç—å_—Å–µ–∫—Ä–µ—Ç": bool(–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢)
        }
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post("/webhook")
async def –æ—Å–Ω–æ–≤–Ω–æ–π_–≤–µ–±—Ö—É–∫(–∑–∞–ø—Ä–æ—Å: Request):
    """–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook –æ—Ç Telegram."""
    –ª–æ–≥.info("üì® –ü–æ–ª—É—á–µ–Ω webhook –∑–∞–ø—Ä–æ—Å –Ω–∞ /webhook")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
            —Å–µ–∫—Ä–µ—Ç_–≤_–∑–∞–≥–æ–ª–æ–≤–∫–µ = –∑–∞–ø—Ä–æ—Å.headers.get("X-Telegram-Bot-Api-Secret-Token")
            if —Å–µ–∫—Ä–µ—Ç_–≤_–∑–∞–≥–æ–ª–æ–≤–∫–µ != –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
                –ª–æ–≥.warning("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ")
                raise HTTPException(status_code=403, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω")
        
        # –ß—Ç–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
        —Ç–µ–ª–æ_–∑–∞–ø—Ä–æ—Å–∞ = await –∑–∞–ø—Ä–æ—Å.body()
        if not —Ç–µ–ª–æ_–∑–∞–ø—Ä–æ—Å–∞:
            –ª–æ–≥.warning("üì≠ –ü–æ–ª—É—á–µ–Ω–æ –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞")
            return JSONResponse({"ok": False, "–æ—à–∏–±–∫–∞": "–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞"})
        
        try:
            –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = json.loads(—Ç–µ–ª–æ_–∑–∞–ø—Ä–æ—Å–∞.decode("utf-8"))
        except json.JSONDecodeError as –æ—à–∏–±–∫–∞:
            –ª–æ–≥.error(f"üî• –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {–æ—à–∏–±–∫–∞}")
            raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON")
        
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.get("update_id", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
            –ª–æ–≥.info(f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è}")
            
            # –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Ñ–æ–Ω–µ
            asyncio.create_task(
                –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, pool=—Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"])
            )
        
        return JSONResponse({
            "ok": True, 
            "—Å—Ç–∞—Ç—É—Å": "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–ø—Ä–∏–Ω—è—Ç–æ",
            "–≤—Ä–µ–º—è": datetime.now().isoformat()
        })
        
    except HTTPException:
        raise
    except Exception as –æ—à–∏–±–∫–∞:
        –ª–æ–≥.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ webhook: {–æ—à–∏–±–∫–∞}")
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post("/webhook/{—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
async def –≤–µ–±—Ö—É–∫_—Å_—Å–µ–∫—Ä–µ—Ç–æ–º(–∑–∞–ø—Ä–æ—Å: Request, —Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å: str):
    """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π webhook —Å —Å–µ–∫—Ä–µ—Ç–æ–º –≤ –ø—É—Ç–∏ URL."""
    –ª–æ–≥.info(f"üì® –ü–æ–ª—É—á–µ–Ω webhook —Å —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –ø—É—Ç–µ–º: /{—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—É—Ç–∏
        if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ and —Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å != –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
            –ª–æ–≥.warning(f"üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å: {—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
            raise HTTPException(status_code=404, detail="–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        
        # –ß—Ç–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
        —Ç–µ–ª–æ_–∑–∞–ø—Ä–æ—Å–∞ = await –∑–∞–ø—Ä–æ—Å.body()
        if not —Ç–µ–ª–æ_–∑–∞–ø—Ä–æ—Å–∞:
            –ª–æ–≥.warning("üì≠ –ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ –≤ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º webhook")
            return JSONResponse({"ok": False, "–æ—à–∏–±–∫–∞": "–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞"})
        
        try:
            –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = json.loads(—Ç–µ–ª–æ_–∑–∞–ø—Ä–æ—Å–∞.decode("utf-8"))
        except json.JSONDecodeError as –æ—à–∏–±–∫–∞:
            –ª–æ–≥.error(f"üî• JSON –æ—à–∏–±–∫–∞ –≤ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º webhook: {–æ—à–∏–±–∫–∞}")
            raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π JSON")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.get("update_id", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
            –ª–æ–≥.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è} —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å")
            
            asyncio.create_task(
                –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, pool=—Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"])
            )
        
        return JSONResponse({
            "ok": True, 
            "—Å—Ç–∞—Ç—É—Å": "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_–ø—Ä–∏–Ω—è—Ç–æ_—á–µ—Ä–µ–∑_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å",
            "–≤—Ä–µ–º—è": datetime.now().isoformat()
        })
        
    except HTTPException:
        raise
    except Exception as –æ—à–∏–±–∫–∞:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –≤ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º webhook: {–æ—à–∏–±–∫–∞}")
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/—Å—Ç–∞—Ç—É—Å")
async def —Å—Ç–∞—Ç—É—Å_—Å–∏—Å—Ç–µ–º—ã():
    """–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã."""
    return JSONResponse({
        "—Å–∏—Å—Ç–µ–º–∞": {
            "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
            "–≤–µ—Ä—Å–∏—è": "1.0.0",
            "–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞": "Railway",
            "python_–≤–µ—Ä—Å–∏—è": f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}",
            "–≤—Ä–µ–º—è_–∑–∞–ø—É—Å–∫–∞": datetime.now().isoformat()
        },
        "–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è": {
            "–ø–æ—Ä—Ç": –ü–û–†–¢,
            "webhook_–ø—É—Ç—å": –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨,
            "webhook_url": –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL or "–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω",
            "–µ—Å—Ç—å_–±–æ—Ç_—Ç–æ–∫–µ–Ω": bool(–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù),
            "–µ—Å—Ç—å_openai_–∫–ª—é—á": bool(–ö–õ–Æ–ß_OPENAI),
            "–µ—Å—Ç—å_–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": bool(URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•)
        },
        "—Å–ª—É–∂–±—ã": {
            "–≤–µ–±_—Å–µ—Ä–≤–µ—Ä": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
            "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–ø–æ–¥–∫–ª—é—á–µ–Ω–∞" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] else "–æ—Ç–∫–ª—é—á–µ–Ω–∞",
            "—Å–∏—Å—Ç–µ–º–∞_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π": "—Ä–∞–±–æ—Ç–∞–µ—Ç" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] else "–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        }
    })

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.exception_handler(Exception)
async def –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–∏—Å–∫–ª—é—á–µ–Ω–∏–π(–∑–∞–ø—Ä–æ—Å: Request, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: Exception):
    """–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π."""
    –ª–æ–≥.error(
        f"üí• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: {–∏—Å–∫–ª—é—á–µ–Ω–∏–µ}", 
        exc_info=True,
        extra={
            "url": str(–∑–∞–ø—Ä–æ—Å.url),
            "method": –∑–∞–ø—Ä–æ—Å.method,
            "headers": dict(–∑–∞–ø—Ä–æ—Å.headers)
        }
    )
    
    return JSONResponse(
        status_code=500,
        content={
            "–æ—à–∏–±–∫–∞": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
            "—Å–æ–æ–±—â–µ–Ω–∏–µ": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            "–≤—Ä–µ–º—è": datetime.now().isoformat(),
            "–∫–æ–¥": 500,
            "–ø–æ–¥–¥–µ—Ä–∂–∫–∞": "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è"
        }
    )

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –æ–±—ã—á–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è uvicorn
app = –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
if __name__ == "__main__":
    import uvicorn
    –ª–æ–≥.info("üîß –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏")
    
    uvicorn.run(
        "main_ru:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        host="0.0.0.0",
        port=–ü–û–†–¢,
        reload=False,
        log_level="info",
        access_log=True
    )
