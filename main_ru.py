"""
–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç - –û—Å–Ω–æ–≤–Ω–æ–µ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
============================================
–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π Telegram –±–æ—Ç —Å:
- –ò–ò —á–∞—Ç —Å –ø–∞–º—è—Ç—å—é –¥–∏–∞–ª–æ–≥–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π  
- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (STT/TTS)
- –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –ø–æ–¥–ø–∏—Å–æ–∫
- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
"""

import asyncio
import json
import logging
import time
from contextlib import asynccontextmanager
from datetime import datetime, timedelta
from typing import Any, Dict, Optional

import structlog
import uvicorn
from fastapi import FastAPI, Request, Response, HTTPException, BackgroundTasks
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse

from config_ru import –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
from database_ru import –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–î
from telegram_ru import –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç
from openai_ru import –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç
from handlers_ru import –û–±—Ä–∞–±–æ—Ç—á–∏–∫–°–æ–æ–±—â–µ–Ω–∏–π
from admin_ru import –ê–¥–º–∏–Ω–ü–∞–Ω–µ–ª—å
from payments_ru import –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π
from analytics_ru import –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
structlog.configure(
    processors=[
        structlog.stdlib.filter_by_level,
        structlog.stdlib.add_logger_name,
        structlog.stdlib.add_log_level,
        structlog.stdlib.PositionalArgumentsFormatter(),
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.UnicodeDecoder(),
        structlog.processors.JSONRenderer()
    ],
    context_class=dict,
    logger_factory=structlog.stdlib.LoggerFactory(),
    wrapper_class=structlog.stdlib.BoundLogger,
    cache_logger_on_first_use=True,
)

–ª–æ–≥ = structlog.get_logger("–≥–ª–∞–≤–Ω–æ–µ_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã
–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥: –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–î = None
—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç: –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç = None
–æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç: –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç = None
–æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–°–æ–æ–±—â–µ–Ω–∏–π = None
–∞–¥–º–∏–Ω_–ø–∞–Ω–µ–ª—å: –ê–¥–º–∏–Ω–ü–∞–Ω–µ–ª—å = None
–º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π: –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π = None
–∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫ = None

# –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
—Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏_—Ä–∞–±–æ—Ç–∞—é—Ç = True

@asynccontextmanager
async def –∂–∏–∑–Ω–µ–Ω–Ω—ã–π_—Ü–∏–∫–ª_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è(app: FastAPI):
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏."""
    global –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π
    global –∞–¥–º–∏–Ω_–ø–∞–Ω–µ–ª—å, –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫
    
    –ª–æ–≥.info("–ó–∞–ø—É—Å–∫ —Ä—É—Å—Å–∫–æ–≥–æ Telegram –±–æ—Ç–∞", –≤–µ—Ä—Å–∏—è=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–≤–µ—Ä—Å–∏—è)
    
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ = –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–î(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö.—Å—Å—ã–ª–∫–∞)
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å()
        –ª–æ–≥.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
        —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç = –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç = –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–æ–ø–µ–Ω–∞–∏.–∞–ø–∏_–∫–ª—é—á, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫ = –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫(–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π = –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π(—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –∞–¥–º–∏–Ω_–ø–∞–Ω–µ–ª—å = –ê–¥–º–∏–Ω–ü–∞–Ω–µ–ª—å(—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π = –û–±—Ä–∞–±–æ—Ç—á–∏–∫–°–æ–æ–±—â–µ–Ω–∏–π(
            —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç=—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç,
            –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç=–æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç,
            –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥=–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥,
            –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π=–º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π,
            –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫=–∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫
        )
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞
        —Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞ = –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞
        if —Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞:
            —É—Å–ø–µ—Ö = await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å_–≤–µ–±—Ö—É–∫(—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞)
            if —É—Å–ø–µ—Ö:
                –ª–æ–≥.info("–í–µ–±—Ö—É–∫ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", —Å—Å—ã–ª–∫–∞=—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞)
            else:
                –ª–æ–≥.error("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫", —Å—Å—ã–ª–∫–∞=—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞)
        else:
            –ª–æ–≥.warning("–°—Å—ã–ª–∫–∞ –≤–µ–±—Ö—É–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
        
        # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
        asyncio.create_task(—Ä–∞–±–æ—Ç–Ω–∏–∫_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π())
        asyncio.create_task(—Ä–∞–±–æ—Ç–Ω–∏–∫_–∞–Ω–∞–ª–∏—Ç–∏–∫–∏())
        asyncio.create_task(—Ä–∞–±–æ—Ç–Ω–∏–∫_–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è())
        
        –ª–æ–≥.info("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ")
        
        yield
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è", –æ—à–∏–±–∫–∞=str(e))
        raise
    finally:
        # –û—á–∏—Å—Ç–∫–∞
        global —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏_—Ä–∞–±–æ—Ç–∞—é—Ç
        —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏_—Ä–∞–±–æ—Ç–∞—é—Ç = False
        
        if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥:
            await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–∑–∞–∫—Ä—ã—Ç—å()
            –ª–æ–≥.info("–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç—ã")
        
        –ª–æ–≥.info("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")

# –°–æ–∑–¥–∞–Ω–∏–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ = FastAPI(
    title="–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
    description="–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π Telegram –±–æ—Ç —Å –ò–ò, –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π",
    version=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–≤–µ—Ä—Å–∏—è,
    lifespan=–∂–∏–∑–Ω–µ–Ω–Ω—ã–π_—Ü–∏–∫–ª_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ CORS middleware
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post("/webhook")
async def –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–≤–µ–±—Ö—É–∫–∞(–∑–∞–ø—Ä–æ—Å: Request, —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏: BackgroundTasks):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Telegram webhook."""
    –≤—Ä–µ–º—è_—Å—Ç–∞—Ä—Ç–∞ = time.perf_counter()
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–∞ –≤–µ–±—Ö—É–∫–∞
        if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞:
            –∑–∞–≥–æ–ª–æ–≤–æ–∫_—Å–µ–∫—Ä–µ—Ç–∞ = –∑–∞–ø—Ä–æ—Å.headers.get("X-Telegram-Bot-Api-Secret-Token")
            if –∑–∞–≥–æ–ª–æ–≤–æ–∫_—Å–µ–∫—Ä–µ—Ç–∞ != –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞:
                –ª–æ–≥.warning("–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞", ip=–∑–∞–ø—Ä–æ—Å.client.host)
                raise HTTPException(status_code=403, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω")
        
        # –ü–∞—Ä—Å–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        —Ç–µ–ª–æ = await –∑–∞–ø—Ä–æ—Å.body()
        if not —Ç–µ–ª–æ:
            raise HTTPException(status_code=400, detail="–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞")
        
        try:
            –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = json.loads(—Ç–µ–ª–æ)
        except json.JSONDecodeError as e:
            –ª–æ–≥.error("–ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ –≤–µ–±—Ö—É–∫–µ", –æ—à–∏–±–∫–∞=str(e))
            raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π JSON")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ–Ω–µ
        —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏.add_task(–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –≤—Ä–µ–º—è_—Å—Ç–∞—Ä—Ç–∞)
        
        return {"ok": True}
        
    except HTTPException:
        raise
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–µ–±—Ö—É–∫–∞", –æ—à–∏–±–∫–∞=str(e))
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: Dict[str, Any], –≤—Ä–µ–º—è_—Å—Ç–∞—Ä—Ç–∞: float):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."""
    try:
        –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.get("update_id")
        –ª–æ–≥.info("–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è=–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
        
        # –ó–∞–ø–∏—Å—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        if –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫:
            –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–∑–∞–ø–∏—Å–∞—Ç—å_–Ω–∞—á–∞–ª–æ_–∑–∞–ø—Ä–æ—Å–∞()
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        if "message" in –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è["message"])
        elif "callback_query" in –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è["callback_query"])
        elif "inline_query" in –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–ª–∞–π–Ω_–∑–∞–ø—Ä–æ—Å(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è["inline_query"])
        elif "pre_checkout_query" in –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_–ø–ª–∞—Ç–µ–∂(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è["pre_checkout_query"])
        elif "successful_payment" in –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
            await –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—É—Å–ø–µ—à–Ω—ã–π_–ø–ª–∞—Ç–µ–∂(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è["successful_payment"], –¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è["message"])
        else:
            –ª–æ–≥.info("–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", –∫–ª—é—á–∏_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è=list(–¥–∞–Ω–Ω—ã–µ_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.keys()))
        
        # –ó–∞–ø–∏—Å—å –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = time.perf_counter() - –≤—Ä–µ–º—è_—Å—Ç–∞—Ä—Ç–∞
        if –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫:
            –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–∑–∞–ø–∏—Å–∞—Ç—å_–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ_–∑–∞–ø—Ä–æ—Å–∞(–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, True)
        
        –ª–æ–≥.info("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ", –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è=–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å=f"{–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:.3f}—Å")
        
    except Exception as e:
        –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = time.perf_counter() - –≤—Ä–µ–º—è_—Å—Ç–∞—Ä—Ç–∞
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", –æ—à–∏–±–∫–∞=str(e), –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å=f"{–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:.3f}—Å")
        
        if –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫:
            –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–∑–∞–ø–∏—Å–∞—Ç—å_–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ_–∑–∞–ø—Ä–æ—Å–∞(–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, False)
            –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–∑–∞–ø–∏—Å–∞—Ç—å_–æ—à–∏–±–∫—É("–æ—à–∏–±–∫–∞_–æ–±—Ä–∞–±–æ—Ç–∫–∏_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—Å–æ–æ–±—â–µ–Ω–∏–µ: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    try:
        if not –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π:
            –ª–æ–≥.error("–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        await –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(—Å–æ–æ–±—â–µ–Ω–∏–µ)
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è", –æ—à–∏–±–∫–∞=str(e), –∏–¥_—Å–æ–æ–±—â–µ–Ω–∏—è=—Å–æ–æ–±—â–µ–Ω–∏–µ.get("message_id"))
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        –∏–¥_—á–∞—Ç–∞ = —Å–æ–æ–±—â–µ–Ω–∏–µ.get("chat", {}).get("id")
        if –∏–¥_—á–∞—Ç–∞ and —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç:
            await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(
                –∏–¥_—á–∞—Ç–∞=–∏–¥_—á–∞—Ç–∞,
                —Ç–µ–∫—Å—Ç="üîß –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                –æ—Ç–≤–µ—Ç_–Ω–∞_—Å–æ–æ–±—â–µ–Ω–∏–µ_–∏–¥=—Å–æ–æ–±—â–µ–Ω–∏–µ.get("message_id")
            )

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å(–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ª–±–µ–∫ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –∏–Ω–ª–∞–π–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä."""
    try:
        if not –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π:
            –ª–æ–≥.error("–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        await –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å(–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å)
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–±–µ–∫ –∑–∞–ø—Ä–æ—Å–∞", –æ—à–∏–±–∫–∞=str(e))
        
        # –û—Ç–≤–µ—Ç –Ω–∞ –∫–æ–ª–±–µ–∫ –∑–∞–ø—Ä–æ—Å —Å –æ—à–∏–±–∫–æ–π
        –∏–¥_–∑–∞–ø—Ä–æ—Å–∞ = –∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å.get("id")
        if –∏–¥_–∑–∞–ø—Ä–æ—Å–∞ and —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç:
            await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.–æ—Ç–≤–µ—Ç–∏—Ç—å_–Ω–∞_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å(
                –∏–¥_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å–∞=–∏–¥_–∑–∞–ø—Ä–æ—Å–∞,
                —Ç–µ–∫—Å—Ç="‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                –ø–æ–∫–∞–∑–∞—Ç—å_—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ=True
            )

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–ª–∞–π–Ω_–∑–∞–ø—Ä–æ—Å(–∏–Ω–ª–∞–π–Ω_–∑–∞–ø—Ä–æ—Å: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–ª–∞–π–Ω –∑–∞–ø—Ä–æ—Å–∞."""
    try:
        if not –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π:
            –ª–æ–≥.error("–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        await –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∏–Ω–ª–∞–π–Ω_–∑–∞–ø—Ä–æ—Å(–∏–Ω–ª–∞–π–Ω_–∑–∞–ø—Ä–æ—Å)
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω–ª–∞–π–Ω –∑–∞–ø—Ä–æ—Å–∞", –æ—à–∏–±–∫–∞=str(e))

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_–ø–ª–∞—Ç–µ–∂(–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_–ø–ª–∞—Ç–µ–∂: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–ª–∞—Ç–µ–∂–∞."""
    try:
        if not –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π:
            –ª–æ–≥.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_–ø–ª–∞—Ç–µ–∂(–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π_–ø–ª–∞—Ç–µ–∂)
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞", –æ—à–∏–±–∫–∞=str(e))

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—É—Å–ø–µ—à–Ω—ã–π_–ø–ª–∞—Ç–µ–∂(–ø–ª–∞—Ç–µ–∂: Dict[str, Any], —Å–æ–æ–±—â–µ–Ω–∏–µ: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞."""
    try:
        if not –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π:
            –ª–æ–≥.error("–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—É—Å–ø–µ—à–Ω—ã–π_–ø–ª–∞—Ç–µ–∂(–ø–ª–∞—Ç–µ–∂, —Å–æ–æ–±—â–µ–Ω–∏–µ)
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞", –æ—à–∏–±–∫–∞=str(e))

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/–∑–¥–æ—Ä–æ–≤—å–µ")
async def –ø—Ä–æ–≤–µ—Ä–∫–∞_–∑–¥–æ—Ä–æ–≤—å—è():
    """–≠–Ω–¥–ø–æ–∏–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã."""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥:
            await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–ø—Ä–æ–≤–µ—Ä–∫–∞_–∑–¥–æ—Ä–æ–≤—å—è()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        —Å—Ç–∞—Ç—É—Å_—Å–µ—Ä–≤–∏—Å–æ–≤ = {
            "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–∑–¥–æ—Ä–æ–≤–∞" if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ else "–Ω–µ_–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞",
            "—Ç–µ–ª–µ–≥—Ä–∞–º": "–∑–¥–æ—Ä–æ–≤" if —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç else "–Ω–µ_–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
            "–æ–ø–µ–Ω–∞–∏": "–∑–¥–æ—Ä–æ–≤" if –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç else "–Ω–µ_–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
        }
        
        # –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        –≤—Å–µ_–∑–¥–æ—Ä–æ–≤—ã = all(—Å—Ç–∞—Ç—É—Å == "–∑–¥–æ—Ä–æ–≤–∞" or —Å—Ç–∞—Ç—É—Å == "–∑–¥–æ—Ä–æ–≤" for —Å—Ç–∞—Ç—É—Å in —Å—Ç–∞—Ç—É—Å_—Å–µ—Ä–≤–∏—Å–æ–≤.values())
        
        return {
            "—Å—Ç–∞—Ç—É—Å": "–∑–¥–æ—Ä–æ–≤" if –≤—Å–µ_–∑–¥–æ—Ä–æ–≤—ã else "–¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–æ",
            "–≤—Ä–µ–º—è": datetime.utcnow().isoformat(),
            "–≤–µ—Ä—Å–∏—è": –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–≤–µ—Ä—Å–∏—è,
            "—Å–µ—Ä–≤–∏—Å—ã": —Å—Ç–∞—Ç—É—Å_—Å–µ—Ä–≤–∏—Å–æ–≤
        }
        
    except Exception as e:
        –ª–æ–≥.error("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –Ω–µ —É–¥–∞–ª–∞—Å—å", –æ—à–∏–±–∫–∞=str(e))
        return JSONResponse(
            status_code=503,
            content={
                "—Å—Ç–∞—Ç—É—Å": "–Ω–µ–∑–¥–æ—Ä–æ–≤",
                "–≤—Ä–µ–º—è": datetime.utcnow().isoformat(),
                "–æ—à–∏–±–∫–∞": str(e)
            }
        )

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def –ø–æ–ª—É—á–∏—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)."""
    try:
        if not –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫:
            raise HTTPException(status_code=503, detail="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
        
        —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ = await –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–ø–æ–ª—É—á–∏—Ç—å_—Å–∏—Å—Ç–µ–º–Ω—É—é_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É()
        return —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", –æ—à–∏–±–∫–∞=str(e))
        raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/–º–µ—Ç—Ä–∏–∫–∏")
async def –ø–æ–ª—É—á–∏—Ç—å_–º–µ—Ç—Ä–∏–∫–∏():
    """–≠–Ω–¥–ø–æ–∏–Ω—Ç –º–µ—Ç—Ä–∏–∫ Prometheus."""
    try:
        if not –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫:
            raise HTTPException(status_code=503, detail="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
        
        –º–µ—Ç—Ä–∏–∫–∏ = await –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–ø–æ–ª—É—á–∏—Ç—å_–º–µ—Ç—Ä–∏–∫–∏_–ø—Ä–æ–º–µ—Ç–µ—É—Å–∞()
        return Response(content=–º–µ—Ç—Ä–∏–∫–∏, media_type="text/plain")
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫", –æ—à–∏–±–∫–∞=str(e))
        raise HTTPException(status_code=500, detail="–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏")

# –§–æ–Ω–æ–≤—ã–µ —Ä–∞–±–æ—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
async def —Ä–∞–±–æ—Ç–Ω–∏–∫_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π():
    """–§–æ–Ω–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    –ª–æ–≥.info("–†–∞–±–æ—Ç–Ω–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω")
    
    while —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏_—Ä–∞–±–æ—Ç–∞—é—Ç:
        try:
            if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ and —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç:
                # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
                –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è = await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–ø–æ–ª—É—á–∏—Ç—å_–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è()
                
                for –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ in –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
                    try:
                        # –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                        await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ(
                            –∏–¥_—á–∞—Ç–∞=–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ["–∏–¥_—á–∞—Ç–∞"],
                            —Ç–µ–∫—Å—Ç=f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['–∑–∞–¥–∞—á–∞']}",
                            —Ä–µ–∂–∏–º_—Ä–∞–∑–º–µ—Ç–∫–∏="HTML"
                        )
                        
                        # –û—Ç–º–µ—Ç–∫–∞ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
                        await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ_–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º(–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ["id"])
                        
                        –ª–æ–≥.info("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", –∏–¥_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è=–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ["id"])
                        
                    except Exception as e:
                        –ª–æ–≥.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", 
                                –∏–¥_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è=–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.get("id"), –æ—à–∏–±–∫–∞=str(e))
            
            # –°–æ–Ω –Ω–∞ 1 –º–∏–Ω—É—Ç—É
            await asyncio.sleep(60)
            
        except Exception as e:
            –ª–æ–≥.error("–û—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π", –æ—à–∏–±–∫–∞=str(e))
            await asyncio.sleep(60)

async def —Ä–∞–±–æ—Ç–Ω–∏–∫_–∞–Ω–∞–ª–∏—Ç–∏–∫–∏():
    """–§–æ–Ω–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ –¥–ª—è —Å–±–æ—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏."""
    –ª–æ–≥.info("–†–∞–±–æ—Ç–Ω–∏–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞–ø—É—â–µ–Ω")
    
    while —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏_—Ä–∞–±–æ—Ç–∞—é—Ç:
        try:
            if –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫:
                # –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
                await –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.—Å–æ–±—Ä–∞—Ç—å_—Å–∏—Å—Ç–µ–º–Ω—ã–µ_–º–µ—Ç—Ä–∏–∫–∏()
                
                # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                await –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫.–æ—á–∏—Å—Ç–∏—Ç—å_—Å—Ç–∞—Ä—ã–µ_–¥–∞–Ω–Ω—ã–µ()
                
                –ª–æ–≥.debug("–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–æ–±—Ä–∞–Ω—ã")
            
            # –°–æ–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç
            await asyncio.sleep(300)
            
        except Exception as e:
            –ª–æ–≥.error("–û—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏", –æ—à–∏–±–∫–∞=str(e))
            await asyncio.sleep(300)

async def —Ä–∞–±–æ—Ç–Ω–∏–∫_–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è():
    """–§–æ–Ω–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ –¥–ª—è –∑–∞–¥–∞—á –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è."""
    –ª–æ–≥.info("–†–∞–±–æ—Ç–Ω–∏–∫ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—É—â–µ–Ω")
    
    while —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏_—Ä–∞–±–æ—Ç–∞—é—Ç:
        try:
            if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥:
                # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π
                await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–æ—á–∏—Å—Ç–∏—Ç—å_—Å—Ç–∞—Ä—ã–µ_—Å–µ—Å—Å–∏–∏()
                
                # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
                await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–æ—á–∏—Å—Ç–∏—Ç—å_—Å—Ç–∞—Ä—ã–µ_—Ä–∞–∑–≥–æ–≤–æ—Ä—ã()
                
                # –í–∞–∫—É—É–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–≤–∞–∫—É—É–º_–±–∞–∑—ã_–¥–∞–Ω–Ω—ã—Ö()
                
                –ª–æ–≥.debug("–ó–∞–¥–∞—á–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã")
            
            # –°–æ–Ω –Ω–∞ 1 —á–∞—Å
            await asyncio.sleep(3600)
            
        except Exception as e:
            –ª–æ–≥.error("–û—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è", –æ—à–∏–±–∫–∞=str(e))
            await asyncio.sleep(3600)

if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(
        level=getattr(logging, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—É—Ä–æ–≤–µ–Ω—å_–ª–æ–≥–∞.upper()),
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )
    
    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    uvicorn.run(
        "main_ru:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        host="0.0.0.0",
        port=int(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–ø–æ—Ä—Ç),
        reload=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–æ—Ç–ª–∞–¥–∫–∞,
        access_log=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–æ—Ç–ª–∞–¥–∫–∞,
        log_level=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—É—Ä–æ–≤–µ–Ω—å_–ª–æ–≥–∞.lower()
    )