"""
–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç v4.0
==========================================
–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–µ–π
"""

import asyncio
import json
import time
from contextlib import asynccontextmanager
from typing import Any, Dict

import structlog
import uvicorn
from fastapi import BackgroundTasks, FastAPI, HTTPException, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse

from config_ru import –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
from database_ru import –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–∞–∑—ã–î–∞–Ω–Ω—ã—Ö
from telegram_ru import –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç
from openai_ru import –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç
from handlers_ru import –û–±—Ä–∞–±–æ—Ç—á–∏–∫–°–æ–æ–±—â–µ–Ω–∏–π
from payments_ru import –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π
from analytics_ru import –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫
from admin_ru import –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–ë–æ—Ç–∞

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
structlog.configure(
    processors=[structlog.dev.ConsoleRenderer(colors=True)],
    wrapper_class=structlog.make_filtering_bound_logger(20),
    logger_factory=structlog.stdlib.LoggerFactory(),
    cache_logger_on_first_use=True,
)

–ª–æ–≥ = structlog.get_logger("–≥–ª–∞–≤–Ω—ã–π")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ = None
—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç = None
–æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç = None
–æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π = None
–º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π = None
–∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫ = None
–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä = None


@asynccontextmanager
async def –∂–∏–∑–Ω–µ–Ω–Ω—ã–π_—Ü–∏–∫–ª_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è(–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: FastAPI):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    await –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_—Å–µ—Ä–≤–∏—Å—ã()
    yield
    await –æ—á–∏—Å—Ç–∏—Ç—å_—Å–µ—Ä–≤–∏—Å—ã()


–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ = FastAPI(
    title="üöÄ AI CHAT 2 - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π –ë–æ—Ç",
    description="–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π AI-–±–æ—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏",
    version="4.0.0",
    lifespan=–∂–∏–∑–Ω–µ–Ω–Ω—ã–π_—Ü–∏–∫–ª_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
)

–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


async def –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å_—Å–µ—Ä–≤–∏—Å—ã():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –±–æ—Ç–∞."""
    global –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π, –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    
    try:
        –ª–æ–≥.info("üöÄ –ó–∞–ø—É—Å–∫ AI CHAT 2...")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
        –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥ = –ú–µ–Ω–µ–¥–∂–µ—Ä–ë–∞–∑—ã–î–∞–Ω–Ω—ã—Ö()
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å()
        –ª–æ–≥.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
        —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç = –¢–µ–ª–µ–≥—Ä–∞–º–ö–ª–∏–µ–Ω—Ç(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç = –û–ø–µ–Ω–ê–ò–ö–ª–∏–µ–Ω—Ç()
        –ª–æ–≥.info("‚úÖ API –∫–ª–∏–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π = –ú–µ–Ω–µ–¥–∂–µ—Ä–ü–ª–∞—Ç–µ–∂–µ–π(—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥)
        –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫ = –ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–≤–∏–∂–æ–∫(–º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥) if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ñ—É–Ω–∫—Ü–∏–∏.–≤–∫–ª—é—á–∏—Ç—å_–∞–Ω–∞–ª–∏—Ç–∏–∫—É else None
        –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä = –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–ë–æ—Ç–∞(—Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫)
        
        # –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º–∏
        –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π = –û–±—Ä–∞–±–æ—Ç—á–∏–∫–°–æ–æ–±—â–µ–Ω–∏–π(
            —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç, –æ–ø–µ–Ω–∞–∏_–∫–ª–∏–µ–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥, 
            –º–µ–Ω–µ–¥–∂–µ—Ä_–ø–ª–∞—Ç–µ–∂–µ–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞_–¥–≤–∏–∂–æ–∫
        )
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞
        if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞:
            await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å_–≤–µ–±—Ö—É–∫(
                –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞,
                –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞
            )
            –ª–æ–≥.info("‚úÖ –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", —Å—Å—ã–ª–∫–∞=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø–æ–ª–Ω–∞—è_—Å—Å—ã–ª–∫–∞_–≤–µ–±—Ö—É–∫–∞)
        
        –ª–æ–≥.info("üéâ AI CHAT 2 —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!")
        
    except Exception as e:
        –ª–æ–≥.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏", –æ—à–∏–±–∫–∞=str(e))
        raise


async def –æ—á–∏—Å—Ç–∏—Ç—å_—Å–µ—Ä–≤–∏—Å—ã():
    """–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏."""
    if —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç:
        await —Ç–µ–ª–µ–≥—Ä–∞–º_–∫–ª–∏–µ–Ω—Ç.–∑–∞–∫—Ä—ã—Ç—å()
    if –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥:
        await –º–µ–Ω–µ–¥–∂–µ—Ä_–±–¥.–∑–∞–∫—Ä—ã—Ç—å()
    –ª–æ–≥.info("üîÑ –°–µ—Ä–≤–∏—Å—ã –æ—á–∏—â–µ–Ω—ã")


# API –º–∞—Ä—à—Ä—É—Ç—ã
@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post(–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.–ø—É—Ç—å_–≤–µ–±—Ö—É–∫–∞)
async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–≤–µ–±—Ö—É–∫(–∑–∞–ø—Ä–æ—Å: Request, —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏: BackgroundTasks):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram."""
    try:
        –¥–∞–Ω–Ω—ã–µ = await –∑–∞–ø—Ä–æ—Å.json()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞
        —Å–µ–∫—Ä–µ—Ç_–∑–∞–≥–æ–ª–æ–≤–æ–∫ = –∑–∞–ø—Ä–æ—Å.headers.get("X-Telegram-Bot-Api-Secret-Token")
        if –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞ and —Å–µ–∫—Ä–µ—Ç_–∑–∞–≥–æ–ª–æ–≤–æ–∫ != –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ç–µ–ª–µ–≥—Ä–∞–º.—Å–µ–∫—Ä–µ—Ç_–≤–µ–±—Ö—É–∫–∞:
            raise HTTPException(status_code=403, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
        if "message" in –¥–∞–Ω–Ω—ã–µ:
            —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏.add_task(
                –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_—Å–æ–æ–±—â–µ–Ω–∏–µ,
                –¥–∞–Ω–Ω—ã–µ["message"]
            )
        elif "callback_query" in –¥–∞–Ω–Ω—ã–µ:
            —Ñ–æ–Ω–æ–≤—ã–µ_–∑–∞–¥–∞—á–∏.add_task(
                –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_—Å–æ–æ–±—â–µ–Ω–∏–π.–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–∫–æ–ª–±–µ–∫_–∑–∞–ø—Ä–æ—Å,
                –¥–∞–Ω–Ω—ã–µ["callback_query"]
            )
        
        return {"status": "ok"}
        
    except Exception as e:
        –ª–æ–≥.error("–û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞", –æ—à–∏–±–∫–∞=str(e))
        raise HTTPException(status_code=500, detail="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞")


@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/–∑–¥–æ—Ä–æ–≤—å–µ")
async def –ø—Ä–æ–≤–µ—Ä–∫–∞_–∑–¥–æ—Ä–æ–≤—å—è():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞."""
    return {
        "—Å—Ç–∞—Ç—É—Å": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–≤–µ—Ä—Å–∏—è": "4.0.0",
        "–≤—Ä–µ–º—è": time.time(),
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "üöÄ AI CHAT 2 - –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –†—É—Å—Å–∫–∏–π –ë–æ—Ç"
    }


if __name__ == "__main__":
    uvicorn.run(
        "main_ru:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        host=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.—Ö–æ—Å—Ç,
        port=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–ø–æ—Ä—Ç,
        reload=–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.–æ—Ç–ª–∞–¥–∫–∞,
        log_level="info"
    )
