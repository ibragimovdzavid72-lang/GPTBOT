"""
–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç - –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å
======================================
–ü—Ä–æ–¥–∞–∫—à–Ω-–≥–æ—Ç–æ–≤—ã–π Telegram –±–æ—Ç —Å –ø–æ–ª–Ω–æ–π —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π
–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å OpenAI GPT-4o –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
"""

import asyncio
import json
import logging
import os
import sys
from contextlib import asynccontextmanager
from datetime import datetime
from typing import Dict, Any, Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler()]
)

–ª–æ–≥ = logging.getLogger("—Ä—É—Å—Å–∫–∏–π_–±–æ—Ç")

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–º–ø–æ—Ä—Ç FastAPI
try:
    from fastapi import FastAPI, Request, HTTPException
    from fastapi.responses import JSONResponse
    from fastapi.middleware.cors import CORSMiddleware
    –ª–æ–≥.info("‚úÖ FastAPI –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ")
except ImportError as –µ:
    –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ FastAPI: {–µ}")
    sys.exit(1)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù = os.getenv("TELEGRAM_BOT_TOKEN", "")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL = os.getenv("TELEGRAM_WEBHOOK_URL", "")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨ = os.getenv("TELEGRAM_WEBHOOK_PATH", "/webhook")
–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ = os.getenv("TELEGRAM_WEBHOOK_SECRET", "supersecret123456")
URL_–ë–ê–ó–´_–î–ê–ù–ù–´–• = os.getenv("DATABASE_URL", "")
–ö–õ–Æ–ß_OPENAI = os.getenv("OPENAI_API_KEY", "")
–ü–û–†–¢ = int(os.getenv("PORT", 8000))

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ webhook –ø—É—Ç–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨ == "/webhook/supersecret123456":
    # –ï—Å–ª–∏ –ø—É—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ä–µ—Ç, —Ä–∞–∑–¥–µ–ª—è–µ–º –µ–≥–æ
    –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨ = "/webhook"
    –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ = "supersecret123456"
    –ª–æ–≥.info("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω webhook –ø—É—Ç—å –∏ —Å–µ–∫—Ä–µ—Ç")

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DATABASE_URL –¥–ª—è asyncpg
def –∏—Å–ø—Ä–∞–≤–∏—Ç—å_url_–±–¥(url):
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å asyncpg."""
    if url and url.startswith('postgresql+asyncpg://'):
        –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π_url = url.replace('postgresql+asyncpg://', 'postgresql://')
        –ª–æ–≥.info("üîß DATABASE_URL –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è asyncpg")
        return –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π_url
    return url

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ URL —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•:
    URL_–ë–ê–ó–´_–î–ê–ù–ù–´–• = –∏—Å–ø—Ä–∞–≤–∏—Ç—å_url_–±–¥(URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•)
# –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è webhook URL –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Railway
if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL and –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
    –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL = f"{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL.rstrip('/')}/webhook/{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢}"
else:
    –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL = f"{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL.rstrip('/')}/webhook" if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL else ""

# –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –º–æ–¥—É–ª–µ–π
async def —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª_–±–¥(url_–±–¥):
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö."""
    if not url_–±–¥:
        –ª–æ–≥.warning("‚ö†Ô∏è URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω")
        return None
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL
    if url_–±–¥.startswith('postgresql+asyncpg://'):
        url_–±–¥ = url_–±–¥.replace('postgresql+asyncpg://', 'postgresql://')
        –ª–æ–≥.info("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏")
    
    –ª–æ–≥.info(f"üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: {url_–±–¥[:50]}...")
    
    try:
        import asyncpg
        –ø—É–ª = await asyncpg.create_pool(url_–±–¥, min_size=2, max_size=10)
        –ª–æ–≥.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ")
        return –ø—É–ª
    except ImportError:
        –ª–æ–≥.warning("‚ö†Ô∏è asyncpg –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return None
    except Exception as –µ:
        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {–µ}")
        –ª–æ–≥.error(f"URL –ë–î –±—ã–ª: {url_–±–¥}")
        return None

async def —Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã_–±–¥(–ø—É–ª):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."""
    if not –ø—É–ª:
        return
    
    try:
        async with –ø—É–ª.acquire() as —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–Ω–∞—á–∞–ª–∞
            await —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.execute("""
                CREATE TABLE IF NOT EXISTS –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (
                    id SERIAL PRIMARY KEY,
                    telegram_id BIGINT UNIQUE NOT NULL,
                    –∏–º—è VARCHAR(255),
                    —Å–æ–∑–¥–∞–Ω TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            """)
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º foreign key
            await —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.execute("""
                CREATE TABLE IF NOT EXISTS —Å–æ–æ–±—â–µ–Ω–∏—è (
                    id SERIAL PRIMARY KEY,
                    –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_id INTEGER REFERENCES –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏(id),
                    —Ç–µ–∫—Å—Ç TEXT,
                    —Å–æ–∑–¥–∞–Ω–æ TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            """)
            
        –ª–æ–≥.info("‚úÖ –¢–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω—ã")
    except Exception as –µ:
        –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {–µ}")
        –ª–æ–≥.warning("‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")

async def –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º(–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, pool=None):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram."""
    –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.get('update_id', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    –ª–æ–≥.info(f"üì® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è}")
    
    if "message" in –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
        —Å–æ–æ–±—â–µ–Ω–∏–µ = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ["message"]
        if "text" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
            —Ç–µ–∫—Å—Ç = —Å–æ–æ–±—â–µ–Ω–∏–µ["text"]
            —á–∞—Ç_–∏–¥ = —Å–æ–æ–±—â–µ–Ω–∏–µ["chat"]["id"]
            –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = —Å–æ–æ–±—â–µ–Ω–∏–µ.get("from", {}).get("first_name", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
            –ª–æ–≥.info(f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}: {—Ç–µ–∫—Å—Ç}")
            
            # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞
            await –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–æ—Ç–≤–µ—Ç_—Ç–µ–ª–µ–≥—Ä–∞–º(—á–∞—Ç_–∏–¥, f"–ü—Ä–∏–≤–µ—Ç, {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}! –ë–æ—Ç –ø–æ–ª—É—á–∏–ª: {—Ç–µ–∫—Å—Ç}")
    
    –ª–æ–≥.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ {–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ")

async def –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–æ—Ç–≤–µ—Ç_—Ç–µ–ª–µ–≥—Ä–∞–º(—á–∞—Ç_–∏–¥, —Ç–µ–∫—Å—Ç):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ Telegram API."""
    if not –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù:
        –ª–æ–≥.warning("‚ö†Ô∏è Telegram Bot Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        return
    
    try:
        import httpx
        
        url = f"https://api.telegram.org/bot{–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù}/sendMessage"
        –¥–∞–Ω–Ω—ã–µ = {
            "chat_id": —á–∞—Ç_–∏–¥,
            "text": —Ç–µ–∫—Å—Ç,
            "parse_mode": "HTML"
        }
        
        async with httpx.AsyncClient() as –∫–ª–∏–µ–Ω—Ç:
            –æ—Ç–≤–µ—Ç = await –∫–ª–∏–µ–Ω—Ç.post(url, json=–¥–∞–Ω–Ω—ã–µ)
            if –æ—Ç–≤–µ—Ç.status_code == 200:
                –ª–æ–≥.info(f"üì§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {—á–∞—Ç_–∏–¥}")
            else:
                –ª–æ–≥.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {–æ—Ç–≤–µ—Ç.status_code}")
                
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {–µ}")

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
try:
    from db import create_pool as –∏–º–ø–æ—Ä—Ç_–ø—É–ª, create_tables as –∏–º–ø–æ—Ä—Ç_—Ç–∞–±–ª–∏—Ü—ã
    —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª_–±–¥ = –∏–º–ø–æ—Ä—Ç_–ø—É–ª
    —Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã_–±–¥ = –∏–º–ø–æ—Ä—Ç_—Ç–∞–±–ª–∏—Ü—ã
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å db –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError:
    –ª–æ–≥.warning("‚ö†Ô∏è –ú–æ–¥—É–ª—å db –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∏")

try:
    from handlers import handle_update as –∏–º–ø–æ—Ä—Ç_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º = –∏–º–ø–æ—Ä—Ç_–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å handlers –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError:
    –ª–æ–≥.warning("‚ö†Ô∏è –ú–æ–¥—É–ª—å handlers –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞")

try:
    from telegram_api import tg_send_message as –∏–º–ø–æ—Ä—Ç_–æ—Ç–ø—Ä–∞–≤–∫–∞
    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–æ—Ç–≤–µ—Ç_—Ç–µ–ª–µ–≥—Ä–∞–º = –∏–º–ø–æ—Ä—Ç_–æ—Ç–ø—Ä–∞–≤–∫–∞
    –ª–æ–≥.info("‚úÖ –ú–æ–¥—É–ª—å telegram_api –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
except ImportError:
    –ª–æ–≥.warning("‚ö†Ô∏è –ú–æ–¥—É–ª—å telegram_api –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞")

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
—Å–æ—Å—Ç–æ—è–Ω–∏–µ = {"–ø—É–ª_–±–¥": None, "—Ä–∞–±–æ—Ç–∞–µ—Ç": False}

@asynccontextmanager
async def –≤—Ä–µ–º—è_–∂–∏–∑–Ω–∏_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è(app: FastAPI):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    –ª–æ–≥.info("üöÄ –ó–∞–ø—É—Å–∫ –†—É—Å—Å–∫–æ–≥–æ AI Telegram –ë–æ—Ç–∞ v1.0")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    –ª–æ–≥.info("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...")
    if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù:
        –ª–æ–≥.info("‚úÖ Telegram Bot Token –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    else:
        –ª–æ–≥.error("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    
    if URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•:
        –ª–æ–≥.info("‚úÖ Database URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    else:
        –ª–æ–≥.warning("‚ö†Ô∏è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    if –ö–õ–Æ–ß_OPENAI:
        –ª–æ–≥.info("‚úÖ OpenAI API Key –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    else:
        –ª–æ–≥.warning("‚ö†Ô∏è OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ webhook
    –ª–æ–≥.info(f"üîó TELEGRAM_WEBHOOK_URL: {–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL or '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}")
    –ª–æ–≥.info(f"üõ§Ô∏è TELEGRAM_WEBHOOK_PATH: {–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨}")
    –ª–æ–≥.info(f"üîë TELEGRAM_WEBHOOK_SECRET: {'–£–°–¢–ê–ù–û–í–õ–ï–ù' if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ else '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}")
    
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        –ª–æ–≥.info("üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        –ø—É–ª = await —Å–æ–∑–¥–∞—Ç—å_–ø—É–ª_–±–¥(URL_–ë–ê–ó–´_–î–ê–ù–ù–´–•)
        if –ø—É–ª:
            await —Å–æ–∑–¥–∞—Ç—å_—Ç–∞–±–ª–∏—Ü—ã_–±–¥(–ø—É–ª)
        else:
            –ª–æ–≥.warning("‚ö†Ô∏è –†–∞–±–æ—Ç–∞ –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] = –ø—É–ª
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] = True
        
        –ª–æ–≥.info("üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        –ª–æ–≥.info(f"üåê –í–µ–±-—Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç {–ü–û–†–¢}")
        
        if –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL:
            –ª–æ–≥.info(f"üîó Webhook URL: {–ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL}")
        else:
            –ª–æ–≥.warning("‚ö†Ô∏è Webhook URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            –ª–æ–≥.warning("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é TELEGRAM_WEBHOOK_URL –≤ Railway")
            –ª–æ–≥.warning("üí° –ù–∞–ø—Ä–∏–º–µ—Ä: https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.railway.app")
        
        yield
        
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {–µ}")
        raise
    finally:
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ["—Ä–∞–±–æ—Ç–∞–µ—Ç"] = False
        if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]:
            try:
                await —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"].close()
                –ª–æ–≥.info("üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫–ª—é—á–µ–Ω–∞")
            except:
                pass
        –ª–æ–≥.info("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")

# –°–æ–∑–¥–∞–Ω–∏–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ = FastAPI(
    title="–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
    description="Telegram –±–æ—Ç —Å –ò–ò –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
    version="1.0.0",
    lifespan=–≤—Ä–µ–º—è_–∂–∏–∑–Ω–∏_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
)

–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"]
)

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/")
async def –≥–ª–∞–≤–Ω–∞—è_—Å—Ç—Ä–∞–Ω–∏—Ü–∞():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏."""
    return JSONResponse({
        "—Å—Ç–∞—Ç—É—Å": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": "–†—É—Å—Å–∫–∏–π AI –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç",
        "–≤–µ—Ä—Å–∏—è": "1.0.0",
        "–≤—Ä–µ–º—è": datetime.now().isoformat(),
        "–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã": {
            "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–ø–æ–¥–∫–ª—é—á–µ–Ω–∞" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] else "–æ—Ç–∫–ª—é—á–µ–Ω–∞",
            "telegram_—Ç–æ–∫–µ–Ω": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
            "openai_–∫–ª—é—á": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –ö–õ–Æ–ß_OPENAI else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        }
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/health")
async def –ø—Ä–æ–≤–µ—Ä–∫–∞_–∑–¥–æ—Ä–æ–≤—å—è():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã."""
    –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã = {
        "–≤–µ–±_—Å–µ—Ä–≤–µ—Ä": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
        "–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö": "–ø–æ–¥–∫–ª—é—á–µ–Ω–∞" if —Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"] else "–æ—Ç–∫–ª—é—á–µ–Ω–∞",
        "telegram_–±–æ—Ç": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù else "–Ω–µ_–Ω–∞—Å—Ç—Ä–æ–µ–Ω",
        "openai_api": "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" if –ö–õ–Æ–ß_OPENAI else "–Ω–µ_–Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    }
    
    –æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å = "–∑–¥–æ—Ä–æ–≤" if –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã["telegram_–±–æ—Ç"] == "–Ω–∞—Å—Ç—Ä–æ–µ–Ω" else "–ø—Ä–æ–±–ª–µ–º—ã"
    
    return JSONResponse({
        "–æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å": –æ–±—â–∏–π_—Å—Ç–∞—Ç—É—Å,
        "–≤—Ä–µ–º—è_–ø—Ä–æ–≤–µ—Ä–∫–∏": datetime.now().isoformat(),
        "–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã": –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.get("/debug/webhook")
async def –æ—Ç–ª–∞–¥–∫–∞_–≤–µ–±—Ö—É–∫–∞():
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ webhook."""
    return JSONResponse({
        "webhook_–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è": {
            "TELEGRAM_WEBHOOK_URL": –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_URL or "–ù–ï_–£–°–¢–ê–ù–û–í–õ–ï–ù",
            "TELEGRAM_WEBHOOK_PATH": –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–ü–£–¢–¨,
            "TELEGRAM_WEBHOOK_SECRET": "–£–°–¢–ê–ù–û–í–õ–ï–ù" if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ else "–ù–ï_–£–°–¢–ê–ù–û–í–õ–ï–ù",
            "–ø–æ–ª–Ω—ã–π_webhook_url": –ü–û–õ–ù–´–ô_–í–ï–ë–•–£–ö_URL or "–ù–ï_–ù–ê–°–¢–†–û–ï–ù"
        },
        "–¥–æ—Å—Ç—É–ø–Ω—ã–µ_–≤–µ–±—Ö—É–∫_–ø—É—Ç–∏": [
            "/webhook",
            "/webhook/supersecret123456",
            f"/webhook/{–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢}" if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢ != "supersecret123456" else "—Ç–æ—Ç_–∂–µ_–∫–∞–∫_–≤—ã—à–µ"
        ],
        "—Ç–µ—Å—Ç_webhook": {
            "url": f"https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.railway.app/webhook/supersecret123456",
            "method": "POST",
            "–æ–ø–∏—Å–∞–Ω–∏–µ": "–û—Ç–ø—Ä–∞–≤—å—Ç–µ POST –∑–∞–ø—Ä–æ—Å —Å Telegram –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º"
        }
    })

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post("/webhook")
async def –æ—Å–Ω–æ–≤–Ω–æ–π_–≤–µ–±—Ö—É–∫(–∑–∞–ø—Ä–æ—Å: Request):
    """–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook."""
    –ª–æ–≥.info("üì® –ü–æ–ª—É—á–µ–Ω webhook –∑–∞–ø—Ä–æ—Å –Ω–∞ /webhook")
    
    try:
        if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
            —Å–µ–∫—Ä–µ—Ç = –∑–∞–ø—Ä–æ—Å.headers.get("X-Telegram-Bot-Api-Secret-Token")
            if —Å–µ–∫—Ä–µ—Ç != –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
                –ª–æ–≥.warning("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω")
                raise HTTPException(status_code=403, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω")
        
        —Ç–µ–ª–æ = await –∑–∞–ø—Ä–æ—Å.body()
        if not —Ç–µ–ª–æ:
            return JSONResponse({"ok": False, "–æ—à–∏–±–∫–∞": "–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ"})
        
        –¥–∞–Ω–Ω—ã–µ = json.loads(—Ç–µ–ª–æ.decode("utf-8"))
        –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –¥–∞–Ω–Ω—ã–µ.get("update_id", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        –ª–æ–≥.info(f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è}")
        
        asyncio.create_task(–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º(–¥–∞–Ω–Ω—ã–µ, pool=—Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]))
        
        return JSONResponse({"ok": True, "—Å—Ç–∞—Ç—É—Å": "–ø—Ä–∏–Ω—è—Ç–æ"})
        
    except json.JSONDecodeError as –µ:
        –ª–æ–≥.error(f"üî• –û—à–∏–±–∫–∞ JSON: {–µ}")
        raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π JSON")
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ webhook: {–µ}")
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.post("/webhook/{—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
async def –≤–µ–±—Ö—É–∫_—Å_—Å–µ–∫—Ä–µ—Ç–æ–º(–∑–∞–ø—Ä–æ—Å: Request, —Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å: str):
    """Webhook —Å —Å–µ–∫—Ä–µ—Ç–æ–º –≤ –ø—É—Ç–∏."""
    –ª–æ–≥.info(f"üì® –ü–æ–ª—É—á–µ–Ω webhook —Å —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –ø—É—Ç–µ–º: /{—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã - –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        –¥–æ–ø—É—Å—Ç–∏–º—ã–µ_—Å–µ–∫—Ä–µ—Ç—ã = ["supersecret123456"]
        if –¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢:
            –¥–æ–ø—É—Å—Ç–∏–º—ã–µ_—Å–µ–∫—Ä–µ—Ç—ã.append(–¢–ï–õ–ï–ì–†–ê–ú_–í–ï–ë–•–£–ö_–°–ï–ö–†–ï–¢)
        
        –ª–æ–≥.info(f"üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å '{—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}' –ø—Ä–æ—Ç–∏–≤ —Å–ø–∏—Å–∫–∞: {–¥–æ–ø—É—Å—Ç–∏–º—ã–µ_—Å–µ–∫—Ä–µ—Ç—ã}")
        
        if —Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å not in –¥–æ–ø—É—Å—Ç–∏–º—ã–µ_—Å–µ–∫—Ä–µ—Ç—ã:
            –ª–æ–≥.warning(f"üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å: {—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
            –ª–æ–≥.warning(f"üö´ –û–∂–∏–¥–∞–ª—Å—è –æ–¥–∏–Ω –∏–∑: {–¥–æ–ø—É—Å—Ç–∏–º—ã–µ_—Å–µ–∫—Ä–µ—Ç—ã}")
            raise HTTPException(status_code=404, detail="–ù–µ –Ω–∞–π–¥–µ–Ω–æ")
        
        –ª–æ–≥.info(f"‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å –ø—Ä–∏–Ω—è—Ç: {—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
        
        —Ç–µ–ª–æ = await –∑–∞–ø—Ä–æ—Å.body()
        if not —Ç–µ–ª–æ:
            –ª–æ–≥.warning("üì≠ –ü–æ–ª—É—á–µ–Ω–æ –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞")
            return JSONResponse({"ok": False, "–æ—à–∏–±–∫–∞": "–ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ"})
        
        –¥–∞–Ω–Ω—ã–µ = json.loads(—Ç–µ–ª–æ.decode("utf-8"))
        –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è = –¥–∞–Ω–Ω—ã–µ.get("update_id", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        –ª–æ–≥.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{–∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è} —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å {—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if "message" in –¥–∞–Ω–Ω—ã–µ:
            —Å–æ–æ–±—â–µ–Ω–∏–µ = –¥–∞–Ω–Ω—ã–µ["message"]
            if "from" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
                –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = —Å–æ–æ–±—â–µ–Ω–∏–µ["from"].get("first_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π")
                –ª–æ–≥.info(f"üë§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å}")
            if "text" in —Å–æ–æ–±—â–µ–Ω–∏–µ:
                —Ç–µ–∫—Å—Ç = —Å–æ–æ–±—â–µ–Ω–∏–µ["text"][:50]
                –ª–æ–≥.info(f"üí¨ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {—Ç–µ–∫—Å—Ç}...")
        
        asyncio.create_task(–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å_–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_—Ç–µ–ª–µ–≥—Ä–∞–º(–¥–∞–Ω–Ω—ã–µ, pool=—Å–æ—Å—Ç–æ—è–Ω–∏–µ["–ø—É–ª_–±–¥"]))
        
        return JSONResponse({
            "ok": True, 
            "—Å—Ç–∞—Ç—É—Å": "–ø—Ä–∏–Ω—è—Ç–æ_—á–µ—Ä–µ–∑_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å",
            "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ_id": –∏–¥_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è,
            "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å": —Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø—É—Ç—å
        })
        
    except json.JSONDecodeError as –µ:
        –ª–æ–≥.error(f"üî• JSON –æ—à–∏–±–∫–∞ –≤ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º –ø—É—Ç–∏: {–µ}")
        raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π JSON")
    except Exception as –µ:
        –ª–æ–≥.error(f"üí• –û—à–∏–±–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ webhook: {–µ}")
        raise HTTPException(status_code=500, detail="–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")

@–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.exception_handler(Exception)
async def –æ–±—Ä–∞–±–æ—Ç—á–∏–∫_–∏—Å–∫–ª—é—á–µ–Ω–∏–π(–∑–∞–ø—Ä–æ—Å: Request, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: Exception):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π."""
    –ª–æ–≥.error(f"üí• –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: {–∏—Å–∫–ª—é—á–µ–Ω–∏–µ}", exc_info=True)
    
    return JSONResponse(
        status_code=500,
        content={
            "–æ—à–∏–±–∫–∞": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
            "–≤—Ä–µ–º—è": datetime.now().isoformat()
        }
    )

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
app = –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

if __name__ == "__main__":
    import uvicorn
    –ª–æ–≥.info("üîß –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫")
    uvicorn.run("main_ru:–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", host="0.0.0.0", port=–ü–û–†–¢, log_level="info")
