"""–§–æ–Ω–æ–≤–∞—è —Å–ª—É–∂–±–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""

import asyncio
import logging
from datetime import datetime

from database_ru import –±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö
from telegram_ru import –ø–æ–ª—É—á–∏—Ç—å_–±–æ—Ç–∞
from utils.keyboards_ru import –ø–æ–ª—É—á–∏—Ç—å_–≥–ª–∞–≤–Ω–æ–µ_–º–µ–Ω—é_–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

logger = logging.getLogger(__name__)


async def –∑–∞–ø—É—Å—Ç–∏—Ç—å_—Å–ª—É–∂–±—É_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π():
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é —Å–ª—É–∂–±—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    logger.info("–ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...")
    
    while True:
        try:
            await –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–∏_–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è()
            await asyncio.sleep(30)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        except asyncio.CancelledError:
            logger.info("–°–ª—É–∂–±–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ—Ç–º–µ–Ω–µ–Ω–∞")
            break
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–ª—É–∂–±—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
            await asyncio.sleep(60)  # –ñ–¥–∞—Ç—å –¥–æ–ª—å—à–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ


async def –ø—Ä–æ–≤–µ—Ä–∏—Ç—å_–∏_–æ—Ç–ø—Ä–∞–≤–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ö."""
    try:
        –±–æ—Ç = –ø–æ–ª—É—á–∏—Ç—å_–±–æ—Ç–∞()
        –æ–∂–∏–¥–∞—é—â–∏–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è = await –±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö.–ø–æ–ª—É—á–∏—Ç—å_–æ–∂–∏–¥–∞—é—â–∏–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è()
        
        for –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ in –æ–∂–∏–¥–∞—é—â–∏–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
            try:
                user_id = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['user_id']
                —Ç–µ–∫—Å—Ç = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['text']
                reminder_id = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['id']
                remind_at = –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['remind_at']
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                –≤—Ä–µ–º—è_—Å—Ç—Ä–æ–∫–∞ = remind_at.strftime("%d.%m.%Y –≤ %H:%M")
                —Å–æ–æ–±—â–µ–Ω–∏–µ = f"‚è∞ <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!</b>\n\n"
                —Å–æ–æ–±—â–µ–Ω–∏–µ += f"üìù {—Ç–µ–∫—Å—Ç}\n\n"
                —Å–æ–æ–±—â–µ–Ω–∏–µ += f"üïê –í—Ä–µ–º—è: {–≤—Ä–µ–º—è_—Å—Ç—Ä–æ–∫–∞}\n"
                —Å–æ–æ–±—â–µ–Ω–∏–µ += f"ID: #{reminder_id}"
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                await –±–æ—Ç.send_message(
                    chat_id=user_id,
                    text=—Å–æ–æ–±—â–µ–Ω–∏–µ,
                    reply_markup=–ø–æ–ª—É—á–∏—Ç—å_–≥–ª–∞–≤–Ω–æ–µ_–º–µ–Ω—é_–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É()
                )
                
                # –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
                await –±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö.–æ—Ç–º–µ—Ç–∏—Ç—å_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ_–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º(reminder_id)
                
                # –ó–∞–ø–∏—Å–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É
                await –±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö.–∑–∞–ø–∏—Å–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(
                    user_id, 'reminder_sent', None, 'success',
                    {
                        'reminder_id': reminder_id,
                        'reminder_text': —Ç–µ–∫—Å—Ç,
                        'scheduled_time': remind_at.isoformat()
                    }
                )
                
                logger.info(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {reminder_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['id']}: {e}")
                
                # –ó–∞–ø–∏—Å–∞—Ç—å –Ω–µ—É–¥–∞—á–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É
                await –±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö.–∑–∞–ø–∏—Å–∞—Ç—å_—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É(
                    –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['user_id'], 'reminder_sent', None, 'error',
                    {
                        'reminder_id': –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ['id'],
                        'error': str(e)
                    }
                )
        
        if –æ–∂–∏–¥–∞—é—â–∏–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(–æ–∂–∏–¥–∞—é—â–∏–µ_–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è)} –æ–∂–∏–¥–∞—é—â–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")